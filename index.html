<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Вигард — калькулятор наливных грузов</title>
  <link rel="icon" href="data:,V" />
  <style>
    :root{--bg:#f7f7f8;--card:#ffffff;--text:#111827;--muted:#6b7280;--accent:#0ea5e9;--good:#16a34a;--bad:#dc2626;--warn:#ca8a04;--border:#e5e7eb}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;background:var(--bg);color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    .title{display:flex;gap:12px;align-items:center;margin:8px 0 16px}
    .title h1{font-size:22px;margin:0}
    .muted{color:var(--muted);font-size:14px}
    .grid{display:grid;gap:16px}
    @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 16px rgba(0,0,0,.04)}
    .card .c{padding:16px}
    label{display:block;font-size:13px;color:#374151;margin:6px 0}
    input,textarea,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;font-size:14px;outline:none}
    input::placeholder{color:#9aa3af}
    input:focus,textarea:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(14,165,233,.15)}
    .row{display:grid;gap:12px}
    @media(min-width:720px){.row.cols-2{grid-template-columns:1fr 1fr}.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-4{grid-template-columns:repeat(4,1fr)}}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    .btn{border:1px solid var(--border);background:#fff;border-radius:12px;padding:10px 14px;font-size:14px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .small{font-size:12px;color:var(--muted)}
    .kpi{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    .kpi .box{border:1px solid var(--border);border-radius:12px;padding:12px}
    .kpi .t{color:var(--muted);font-size:12px}
    .kpi .v{font-weight:600;font-size:18px}
    .banner{border:1px dashed #facc15;background:#fffbeb;padding:12px;border-radius:12px}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{font-size:14px;vertical-align:middle}
    th{color:#374151;text-align:left}
    td>input,td>select{width:100%}
    .cap{font-size:12px;color:#6b7280}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef6ff;color:#0b6aa8;font-size:12px}
    .warn{color:#b45309}
    .danger{color:#b91c1c}
    details.tests{margin-top:12px}
    details.tests summary{cursor:pointer}
    .pass{color:#16a34a}
    .fail{color:#dc2626}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.3);padding:20px;z-index:20}
    .modal.open{display:flex}
    .modal>.sheet{background:#fff;border-radius:16px;padding:16px;max-width:640px;width:100%;border:1px solid var(--border)}
    .toast{position:fixed;bottom:24px;right:24px;background:#111827;color:#fff;padding:12px 16px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.15);opacity:0;pointer-events:none;transform:translateY(20px);transition:opacity .3s ease,transform .3s ease;z-index:40}
    .toast.show{opacity:1;transform:translateY(0)}
    .row.inline{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <div style="width:36px;height:36px;border-radius:10px;background:#e0f2fe;display:flex;align-items:center;justify-content:center;font-weight:700;color:#0369a1">V</div>
      <div>
        <h1>Вигард — калькулятор наливных грузов</h1>
        <div class="muted">Груз всегда застрахован. ДОПОГ соблюдаем.</div>
      </div>
    </div>

    <!-- Конфигурация -->
    <div class="card"><div class="c">
      <h2 style="margin:0 0 12px">Конфигурация</h2>
      <div class="row cols-3">
  <div>
    <label>Тягач (оси)</label>
    <select id="tractorAxles">
      <option value="2">2</option>
      <option value="3">3</option>
    </select>
  </div>

  <div>
    <label>Тягач (госномер)</label>
    <div style="display:flex;gap:6px;align-items:center">
      <select id="tractorSelect" style="flex:1"></select>
      <button class="btn" id="addTruck" title="Добавить тягач">+</button>
    </div>
  </div>

  <div>
    <label>Прицеп (номер)</label>
    <div style="display:flex;gap:6px;align-items:center">
      <select id="trailerSelect" style="flex:1"></select>
      <button class="btn" id="addTrailer" title="Добавить прицеп">+</button>
    </div>
  </div>
</div>

<div id="trailerInfo" class="small" style="margin-top:6px"></div>

    </div></div>

    <!-- Маршрут и стоимость -->
    <div class="card"><div class="c">
      <h2 style="margin:0 0 12px">Маршрут и стоимость</h2>

      <div class="row cols-3">
        <div>
          <label>Провайдер маршрута</label>
          <select id="provider">
            <option value="google">Google</option>
            <option value="yandex">Яндекс</option>
          </select>
        </div>
        <div>
          <label>Режим расстояния</label>
          <select id="distanceMode">
            <option value="manual">Вручную</option>
            <option value="maps">Через карты</option>
          </select>
        </div>
        <div>
          <label>API-ключ (для карт)</label>
          <input id="mapsKey" placeholder="вставьте ключ API">
        </div>
      </div>

      <!-- Поля маршрута ВСЕГДА видны -->
      <div class="row cols-3" id="routeRow">
        <div>
          <label>Откуда (город)</label>
          <input id="routeFrom" placeholder="Введите название">
        </div>
        <div>
          <label>Куда (город)</label>
          <input id="routeTo" placeholder="Введите название">
        </div>
        <div style="align-self:end" class="btns">
          <label class="small" style="display:flex;gap:6px;align-items:center"><input id="avoidTolls" type="checkbox"> избегать платных</label>
          <label class="small" style="display:flex;gap:6px;align-items:center"><input id="truckMode" type="checkbox" checked> грузовой режим*</label>
          <button class="btn" id="btnRoute">Построить маршрут</button>
        </div>
      </div>
      <div class="small" id="mapsNote" style="display:none;margin-top:6px">* «Грузовой режим» приблизительно учитывает объезды (добавляет ~12% к километражу). Для строгих ограничений можно интегрировать HERE/Yandex Truck API.</div>

      <div class="row cols-3" style="margin-top:8px">
        <div>
          <label>Расстояние, км (если вручную)</label>
          <input id="distanceKm" type="number" placeholder="введите число">
        </div>
        <div>
          <label>Ставка, ₽/км</label>
          <input id="ratePerKm" type="number" placeholder="например 120">
        </div>
        <div>
          <label>Количество рейсов</label>
          <input id="trips" type="number" value="1">
        </div>
      </div>

      <div class="kpi" style="margin-top:12px">
        <div class="box"><div class="t">Расстояние</div><div class="v" id="kpiDistance">—</div></div>
        <div class="box"><div class="t">Ставка</div><div class="v" id="kpiRate">—</div></div>
        <div class="box"><div class="t">Рейсов</div><div class="v" id="kpiTrips">—</div></div>
        <div class="box"><div class="t">Итого стоимость</div><div class="v" id="kpiCost">—</div></div>
      </div>
    </div></div>

    <div class="grid" style="margin-top:16px">
      <!-- Цистерна / Площадка -->
      <div class="card"><div class="c">
        <h3 style="margin:0 0 8px">Отсеки / позиции</h3>

        <div id="tankSection">
          <div id="singleCargoWrap" style="display:none;margin:6px 0 12px">
            <div class="row cols-3">
              <div>
                <label>Тип груза</label>
                <select id="singleType"></select>
              </div>
              <div>
                <label>ADR</label>
                <select id="singleAdr"><option>Не знаю</option><option>3</option><option>8</option><option>—</option></select>
              </div>
              <div>
                <label>ρ (кг/л)</label>
                <input id="singleRho" type="number" step="0.001">
              </div>
            </div>
            <div class="row cols-3" style="margin-top:8px">
              <div>
                <label>Объём, л</label>
                <input id="singleL" type="number">
              </div>
              <div>
                <label>Тонны, т</label>
                <input id="singleT" type="number">
              </div>
              <div>
                <label>Объём, м³</label>
                <input id="singleM3" type="number">
              </div>
            </div>
          </div>
          <div class="row inline" style="justify-content:space-between;margin:6px 0 8px">
            <label class="small" style="display:flex;gap:8px;align-items:center"><input id="chkAllSame" type="checkbox"> все отсеки — один груз</label>
            <button class="btn" id="btnAddProduct">+ Добавить груз</button>
          </div>
          <div class="row cols-2" style="margin:6px 0 10px">
            <div>
              <label>Сколько везём (масса), т</label>
              <div style="display:flex;gap:8px">
                <input id="totalMassT" type="number" placeholder="Введите">
                <button class="btn" id="btnDistributeMass" style="white-space:nowrap">Распределить по массе</button>
              </div>
            </div>
            <div>
              <label>Сколько везём (объём), м³</label>
              <div style="display:flex;gap:8px">
                <input id="totalVolM3" type="number" placeholder="Введите">
                <button class="btn" id="btnDistributeM3" style="white-space:nowrap">Распределить по объёму</button>
              </div>
            </div>
          </div>
          <div class="small" style="margin:-6px 0 8px">При включённой галке «все отсеки — один груз» используйте общую строку сверху — плотность берётся из выбранного типа.</div>
          <table>
            <thead>
              <tr>
                <th>Отсек</th><th>Тип груза</th><th>ADR</th><th>ρ (кг/л)</th><th>Объём, л</th><th>Тонны, т</th><th>Объём, м³</th>
              </tr>
            </thead>
            <tbody id="tankBody"></tbody>
          </table>

          <div class="small">Лимиты по отсекам: <span id="capsLine"></span></div>
          <div class="small" id="fitSummary" style="margin-top:6px"></div>

          <div class="btns" style="margin-top:8px">
            <button class="btn" id="fillMax">Заполнить по максимуму</button>
            <button class="btn" id="clearAll">Очистить</button>
          </div>
        </div>

        <div id="platformSection" style="display:none">
          <table>
            <thead><tr><th>Позиция</th><th>Масса, кг</th></tr></thead>
            <tbody id="platBody"></tbody>
          </table>
        </div>
      </div></div>

      <!-- Итоги -->
      <div class="card"><div class="c">
        <h3 style="margin:0 0 8px">Итоги и предупреждения</h3>
        <div class="kpi">
          <div class="box"><div class="t">Сумма литров</div><div class="v" id="sumL">—</div></div>
          <div class="box"><div class="t">Сумма тонн</div><div class="v" id="sumT">—</div></div>
        </div>
        <ul id="warnList" class="small" style="margin-top:8px"></ul>
        <div style="margin-top:16px">
          <div style="font-weight:600;margin-bottom:6px">Мини-бриф</div>
          <textarea id="brief" rows="8" readonly></textarea>
        </div>
        <div class="btns" style="margin-top:8px">
          <button class="btn" id="copyBrief">Скопировать мини-бриф</button>
          <button class="btn primary" id="submitBtn">Оформить / Сохранить расчёт</button>
        </div>

        <details class="tests"><summary>Тесты (debug)</summary>
          <div class="btns" style="margin:8px 0"><button class="btn" id="runTests">Запустить тесты</button></div>
          <div id="testResults" class="small"></div>
        </details>
      </div></div>
    </div>
  </div>

  <!-- Modal: прицеп -->
  <div id="modal" class="modal"><div class="sheet">
    <h3 style="margin-top:0">Добавить прицеп</h3>
    <div class="row cols-2">
      <div><label>Номер (как в списке)</label><input id="m_name" placeholder="МК 9999 23"></div>
      <div><label>Тип</label><select id="m_type"><option value="tanker">Цистерна</option><option value="platform">Площадка</option></select></div>
    </div>
    <div class="row cols-3">
      <div><label>Оси</label><select id="m_axles"><option>3</option><option selected>4</option></select></div>
      <div><label>Тара, кг</label><input id="m_tare" type="number" placeholder="7800"></div>
      <div id="m_positions_wrap" style="display:none"><label>Позиции (для площадки)</label><input id="m_positions" type="number" value="4"></div>
    </div>
    <div id="m_caps_wrap"><label>Отсеки (литры) через «/»</label><input id="m_caps" placeholder="10000/8000/9000"></div>
    <div class="btns" style="margin-top:10px">
      <button class="btn primary" id="m_save">Сохранить</button>
      <button class="btn" id="m_cancel">Отмена</button>
    </div>
  </div></div>

  <!-- Modal: тягач -->
  <div id="modalTruck" class="modal"><div class="sheet">
    <h3 style="margin-top:0">Добавить тягач</h3>
    <div class="row cols-2">
      <div><label>Госномер</label><input id="mt_plate" placeholder="А 123 БВ 93"></div>
      <div><label>Оси</label><select id="mt_axles"><option value="2" selected>2</option><option value="3">3</option></select></div>
    </div>
    <div class="btns" style="margin-top:10px">
      <button class="btn primary" id="mt_save">Сохранить</button>
      <button class="btn" id="mt_cancel">Отмена</button>
    </div>
  </div></div>

  <!-- Modal: продукт -->
  <div id="modalProduct" class="modal"><div class="sheet">
    <h3 style="margin-top:0">Добавить груз</h3>
    <div class="row cols-1">
      <div><label>Название</label><input id="mp_name" placeholder="Например, Новая смесь"></div>
      <div><label>Плотность ρ, кг/л</label><input id="mp_rho" type="number" step="0.001" placeholder="1.000"></div>
      <div><label>ADR</label><select id="mp_adr"><option>Не знаю</option><option>3</option><option>8</option><option>—</option></select></div>
    </div>
    <div class="btns" style="margin-top:10px">
      <button class="btn primary" id="mp_save">Сохранить</button>
      <button class="btn" id="mp_cancel">Отмена</button>
    </div>
  </div></div>

  <div id="toast" class="toast"></div>

  <!-- Axle calc -->
  <div class="wrap" style="margin-top:8px">
    <div class="card"><div class="c">
      <h2 style="margin:0 0 12px">Расчёт нагрузок на оси</h2>
      <div class="small" style="margin:-6px 0 10px">Упрощённая статика для автопоезда (тягач + полуприцеп). Если нет точной геометрии — используются типовые значения.</div>

      <h3 style="margin:8px 0">Параметры тягача</h3>
      <div class="row cols-3">
        <div>
          <label>Оси тягача</label>
          <select id="axTr_axle"><option value="2">2</option><option value="3">3</option></select>
        </div>
        <div>
          <label>База LT (мм, 1-я ↔ задняя группа)</label>
          <input id="LT_ax" type="number" value="3800" />
        </div>
        <div>
          <label>l2 (мм, задняя ось → седло)</label>
          <input id="l2_ax" type="number" value="350" />
        </div>
      </div>
      <div class="row cols-3">
        <div>
          <label>Нагрузка пустого: перед NT1,0 (кг)</label>
          <input id="NT10_ax" type="number" value="4200" />
        </div>
        <div>
          <label>Нагрузка пустого: зад гр. NT2,0 (кг)</label>
          <input id="NT20_ax" type="number" value="4000" />
        </div>
        <div>
          <label>Оси прицепа (из пресета)</label>
          <input id="axTl_ax" type="number" value="3" readonly />
        </div>
      </div>

      <h3 style="margin:8px 0">Параметры полуприцепа</h3>
      <div class="row cols-4">
        <div>
          <label>Масса пустого mp (кг)</label>
          <input id="mp_ax" type="number" value="7300" />
        </div>
        <div>
          <label>LA (мм, длина площадки)</label>
          <input id="LA_ax" type="number" value="12000" />
        </div>
        <div>
          <label>LB (мм, центр тележки → седло)</label>
          <input id="LB_ax" type="number" value="7600" />
        </div>
        <div>
          <label>LC (мм, центр тележки → зад)</label>
          <input id="LC_ax" type="number" value="4400" />
        </div>
      </div>
      <div class="row cols-3">
        <div>
          <label>Нагрузка пустого на седло NTp.p. (кг)</label>
          <input id="NTpp_ax" type="number" value="2000" />
        </div>
        <div style="align-self:end" class="btns">
          <button class="btn" id="recalcAxles">Пересчитать оси</button>
        </div>
      </div>

      <div class="kpi" style="margin-top:12px">
        <div class="box"><div class="t">Масса автопоезда</div><div class="v" id="G_total_ax">—</div></div>
        <div class="box"><div class="t">Ось 1 (передняя, тягач)</div><div class="v" id="Ax1_ax">—</div></div>
        <div class="box"><div class="t">Задняя группа тягача</div><div class="v" id="Ax2_ax">—</div></div>
        <div class="box"><div class="t">Тележка прицепа (сумма / по оси)</div><div class="v" id="AxTl_ax">—</div></div>
      </div>
      <div class="banner" id="axWarn_ax" style="display:none;margin-top:10px"></div>
      <div class="small" style="margin-top:6px">Грубая модель: равномерное распределение по тележке прицепа и задней группе тягача. Для точного расчёта нужны паспортные размеры.</div>
    </div></div>
  </div>

<script>
/* ===================== Helpers ===================== */
function $(id){ return document.getElementById(id); }
function num(v,def=0){ const n=parseFloat(v); return isFinite(n)?n:def; }
function fmtL(n){ return isFinite(n)? Math.round(n).toLocaleString('ru-RU')+' л':'—'; }
function fmtKg(n){ return isFinite(n)? Math.round(n).toLocaleString('ru-RU')+' кг':'—'; }
function fmtT(n){ return isFinite(n)? n.toLocaleString('ru-RU',{minimumFractionDigits:3,maximumFractionDigits:3})+' т':'—'; }
function fmtM3(n){ return isFinite(n)? n.toFixed(3)+' м³':'—'; }
function roundLiters(n){ return Math.round(n); }
function showToast(msg){ const el=$('toast'); if(!el){ alert(msg); return; } el.textContent=msg; el.classList.add('show'); clearTimeout(toastTimer); toastTimer=setTimeout(()=>el.classList.remove('show'),3000); }
let distributing=false;
let singleUpdating=false;
let toastTimer=null;

/* ===================== Data ===================== */
const BASE_PRODUCTS = [
  { key: "diesel", label: "Дизельное топливо (ДТ)", rho: 0.84, adr: "3" },
  { key: "gas92", label: "Бензин АИ-92", rho: 0.74, adr: "3" },
  { key: "gas95", label: "Бензин АИ-95", rho: 0.75, adr: "3" },
  { key: "molasses", label: "Патока", rho: 1.40, adr: "—" },
  { key: "syrup", label: "Сироп сахарный", rho: 1.30, adr: "—" },
  { key: "wine", label: "Вино", rho: 0.99, adr: "—" },
  { key: "ethanol96", label: "Спирт этиловый (96%)", rho: 0.789, adr: "3" },
  { key: "methanol", label: "Метанол", rho: 0.792, adr: "3" },
  { key: "vinyl_acetate", label: "Винилацетат мономер (VAM)", rho: 0.934, adr: "3" },
  { key: "butyl_acetate", label: "Бутилацетат", rho: 0.882, adr: "3" },
  { key: "methyl_acetate", label: "Метилацетат", rho: 0.932, adr: "3" },
  { key: "ethyl_acetate", label: "Этил ацетат", rho: 0.902, adr: "3" },
  { key: "n_butanol", label: "н-Бутанол", rho: 0.810, adr: "3" },
  { key: "acetic_acid_glacial", label: "Уксусная кислота (ледяная)", rho: 1.049, adr: "8" },
  { key: "sulfuric_acid_96", label: "Серная кислота (96–98%)", rho: 1.830, adr: "8" },
  { key: "heavy_oil", label: "Тяжёлые масла", rho: 0.93, adr: "3/—" },
  { key: "formalin37", label: "Формалин 37%", rho: 1.09, adr: "8" }
];

const BASE_TRUCKS = [
  "В 010 СЕ 123","М 020 АМ 123","Е 030 ВК 123","Е 040 ВК 123","Т 050 ВТ 93","Н 060 ВТ 123","С 070 УА 93",
  "Р 100 СА 93","Н 200 НУ 23","У 300 ХА 93","Х 400 СХ 93","О 600 РВ 93",
  "В 800 ТУ 93","В 900 ТУ 93","С 101 ОХ 123","Е 202 УО 93","А 303 ЕР 123","Т 404 РС 123","Р 505 МВ 123","У 606 МВ 123",
  "О 707 СУ 123","У 808 РУ 123","У 909 СН 123","Е 111 КС 123","Р 212 СН 23","Т 313 РУ 93","Н 414 РВ 93","Х 515 ТМ 93",
  "У 616 СН 123","Х 717 РН 93","Р 919 ВК 93","У 616 СН 123","С 999 РХ 123","А 444 АУ 23","О 555 КК 123","Т 777 АК 123","Н 888 РС 123"
];

const BASE_TRAILERS = [
  { id: "ER8977_23", name: "ЕР 8977 23", type: "platform", axles: 3, tareKg: 5900, positions: 4 },
  { id: "EU2938_23", name: "ЕУ 2938 23", type: "tanker", axles: 3, tareKg: 7300, compartmentsLiters: [12000, 6500, 12500] },
  { id: "MM8442_23", name: "ММ 8442 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [29340] },
  { id: "MM8041_23", name: "ММ 8041 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [29310] },
  { id: "MO7958_23", name: "МО 7958 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [13000, 7000, 13000] },
  { id: "MA2567_23", name: "МА 2567 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [9000, 8000, 10000] },
  { id: "MN9545_23", name: "МН 9545 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [9000, 8000, 10000] },
  { id: "MK6187_23", name: "МК 6187 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [11000, 6000, 13000] },
  { id: "MO0310_23", name: "МО 0310 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [7500, 11000, 7500, 6000] },
  { id: "MO1891_23", name: "МО 1891 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [9000, 8000, 13000] },
  { id: "MM8413_23", name: "ММ 8413 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [29340] },
  { id: "EU9285_23", name: "ЕУ 9285 23", type: "tanker", axles: 3, tareKg: 7300, compartmentsLiters: [3000, 13850, 11750] },
  { id: "EU2937_23", name: "ЕУ 2937 23", type: "tanker", axles: 3, tareKg: 7300, compartmentsLiters: [3000, 13850, 11750] },
  { id: "MR3376_23", name: "МР 3376 23", type: "tanker", axles: 3, tareKg: 7300, compartmentsLiters: [3000, 13850, 11750] },
  { id: "MA8877_23", name: "МА 8877 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [9000, 5000, 12000] },
  { id: "MN6880_23", name: "МН 6880 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [29130] },
  { id: "EU8672_23", name: "ЕУ 8672 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [12500, 7500, 7500, 12500] },
  { id: "MM8488_23", name: "ММ 8488 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [29130] },
  { id: "MM4239_23", name: "ММ 4239 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [9000, 4000, 6000, 11000] },
  { id: "MA8880_23", name: "МА 8880 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [9000, 4000, 6000, 11000] },
  { id: "MK6180_23", name: "МК 6180 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [13500, 7500, 7500, 9350] },
  { id: "EU5123_23", name: "ЕУ 5123 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [11000, 7500, 10000] },
  { id: "MK5737_23", name: "МК 5737 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [30000] },
  { id: "ET0683_23", name: "ЕТ 0683 23", type: "tanker", axles: 3, tareKg: 7300, compartmentsLiters: [22000] },
  { id: "MO0882_23", name: "МО 0882 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [10365, 6925, 10450] },
  { id: "MA2562_23", name: "МА 2562 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [9000, 8000, 9000] },
  { id: "MU5054_23", name: "МУ 5054 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [11422, 4556, 12653] },
  { id: "MK5702_23", name: "МК 5702 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [9750, 7500, 7500, 7500] },
  { id: "EU5224_23", name: "ЕУ 5224 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [11000, 5500, 4500, 11000] },
  { id: "MM6410_23", name: "ММ 6410 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [10000, 7000, 5000, 10000] },
  { id: "ET3627_23", name: "ЕТ 3627 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [10500, 5000, 6500, 10000] },
  { id: "MA3650_23", name: "МА 3650 23", type: "tanker", axles: 4, tareKg: 7800, compartmentsLiters: [9000, 8000, 12000] }
];

const LS_KEYS = {
  custom: 'vigard_custom_trailers_v1',
  products: 'vigard_custom_products_v1',
  trucks: 'vigard_custom_trucks_v1',
  truckAxlesMap: 'vigard_truck_axles_map_v1',
  state:  'vigard_state_v8',
  legacyState: 'vigard_state_v7'
};

/* ========== Products (add/custom) ========== */
function getAllProducts(){ const custom = JSON.parse(localStorage.getItem(LS_KEYS.products)||'[]'); return [...BASE_PRODUCTS, ...custom]; }
function addCustomProduct(label, rho, adr){
  const key = ('custom_'+label).toLowerCase().replace(/\s+/g,'_').replace(/[^\wа-яё_-]/gi,'');
  const list = JSON.parse(localStorage.getItem(LS_KEYS.products)||'[]'); list.push({ key, label, rho, adr });
  localStorage.setItem(LS_KEYS.products, JSON.stringify(list));
}

/* ========== Trucks ========== */
function getAllTrucks(){ const custom = JSON.parse(localStorage.getItem(LS_KEYS.trucks)||'[]'); return [...BASE_TRUCKS, ...custom]; }
function getTruckAxles(plate){ try{ const map = JSON.parse(localStorage.getItem(LS_KEYS.truckAxlesMap)||'{}'); return map[plate]||null; }catch(e){ return null; } }
function setTruckAxles(plate, axles){
  if(!plate) return; let map={}; try{ map = JSON.parse(localStorage.getItem(LS_KEYS.truckAxlesMap)||'{}'); }catch(e){}
  map[plate]=axles; localStorage.setItem(LS_KEYS.truckAxlesMap, JSON.stringify(map));
}

/* ========== Trailers ========== */
function getAllTrailers(){ const custom = JSON.parse(localStorage.getItem(LS_KEYS.custom)||'[]'); return [...BASE_TRAILERS, ...custom]; }
function renderTrailerSelect(selectedId){
  const sel=$('trailerSelect'); sel.innerHTML='';
  getAllTrailers().forEach(t=>{ const opt=document.createElement('option'); opt.value=t.id; opt.textContent=t.name; if(t.id===selectedId) opt.selected=true; sel.appendChild(opt); });
}
function renderTractorSelect(selected){
  const sel=$('tractorSelect'); sel.innerHTML='';
  getAllTrucks().forEach(num=>{ const opt=document.createElement('option'); opt.value=num; opt.textContent=num; sel.appendChild(opt); });
  if(selected) sel.value=selected;
}
function setTrailerInfo(t){
  const info=$('trailerInfo'); if(!t){ info.textContent=''; return; }
  if(t.type==='tanker') info.innerHTML=`Тип: цистерна · Оси: ${t.axles} · Тара: ${t.tareKg||'—'} кг · Отсеки: ${t.compartmentsLiters.join(' / ')} л (∑ ${t.compartmentsLiters.reduce((a,b)=>a+b,0)} л)`;
  else info.innerHTML=`Тип: площадка · Оси: ${t.axles} · Тара: ${t.tareKg||'—'} кг · Позиции: ${t.positions||4}`;
}

/* ========== Tanker table ========== */
function densityOptionsHtml(selectedKey){
  const opts=[`<option value="" ${selectedKey?'':'selected'}>— выберите тип —</option>`];
  getAllProducts().forEach(d=>{
    opts.push(`<option value="${d.key}" ${d.key===selectedKey?'selected':''}>${d.label}</option>`);
  });
  return opts.join('');
}
function buildTankRows(state){
  const tb=$('tankBody'); tb.innerHTML='';
  const caps=state.caps||[];
  const capsLine=$('capsLine');
  if(capsLine){
    capsLine.textContent='';
    const wrapper=capsLine.closest('.small');
    if(wrapper) wrapper.style.display='none';
  }
  state.rows.forEach((row,idx)=>{
    const tr=document.createElement('tr');
    tr.dataset.index=idx;
    tr.dataset.lastInput=row.lastInput||'liters';
    const tonsDisplay = isFinite(row.tons)? row.tons.toFixed(3) : (isFinite(row.kg)? (row.kg/1000).toFixed(3) : '');
    const litersDisplay = isFinite(row.liters)? (row.liters===0? '0':Math.round(row.liters)) : '';
    const rhoDisplay = isFinite(row.rho)? row.rho : '';
    const m3Display = isFinite(row.m3)? row.m3.toFixed(3) : (isFinite(row.liters)? (row.liters/1000).toFixed(3) : '');
    tr.innerHTML=`
      <td><span class="pill">#${idx+1}</span><div class="cap">лимит ${caps[idx]??'—'} л</div></td>
      <td><select class="selType">${densityOptionsHtml(row.typeKey||'')}</select></td>
      <td><select class="selAdr"><option>Не знаю</option><option>3</option><option>8</option><option>—</option></select></td>
      <td><input class="inpRho" type="number" step="0.001" value="${rhoDisplay}"></td>
      <td><input class="inpL" type="number" value="${litersDisplay}"></td>
      <td><input class="inpT" type="number" value="${tonsDisplay}"></td>
      <td><input class="inpM3" type="number" readonly value="${m3Display}"></td>`;
    if(isFinite(row.liters)) tr.dataset.exactL=row.liters;
    else delete tr.dataset.exactL;
    tb.appendChild(tr);
    const adrSel=tr.querySelector('.selAdr');
    adrSel.value=row.adr||'Не знаю';
  });
}

function buildSingleRow(state){
  const wrap=$('singleCargoWrap');
  if(!wrap) return;
  const single=state.single||{typeKey:'', adr:'Не знаю', rho:null, liters:null, tons:null, m3:null};
  const isAllSame=!!state.allSame;
  wrap.style.display='block';
  singleUpdating=true;
  $('singleType').innerHTML=densityOptionsHtml(single.typeKey||'');
  $('singleAdr').value=single.adr||'Не знаю';
  $('singleAdr').disabled=!isAllSame;
  $('singleRho').value = isFinite(single.rho)? single.rho : '';
  $('singleRho').disabled=false;
  $('singleL').value = isFinite(single.liters)? (single.liters===0?'0':Math.round(single.liters)) : '';
  $('singleT').value = isFinite(single.tons)? single.tons.toFixed(3) : '';
  $('singleM3').value = isFinite(single.m3)? single.m3.toFixed(3) : '';
  $('singleL').disabled=!isAllSame;
  $('singleT').disabled=!isAllSame;
  $('singleM3').disabled=!isAllSame;
  singleUpdating=false;
}

function resolveDensity(tr){
  const typeKey=tr.querySelector('.selType').value;
  const dict=getAllProducts().find(d=>d.key===typeKey);
  const rhoInp=tr.querySelector('.inpRho');
  let rho=parseFloat(rhoInp.value);
  const idx=parseInt(tr.dataset.index,10);
  const row=app.trailerState?.rows?.[idx];
  const manual=row?.rhoManual;
  if((!isFinite(rho) || rho<=0)){
    if(!manual && dict?.rho>0){ rho=dict.rho; if(rhoInp) rhoInp.value=dict.rho; }
    else rho=NaN;
  }
  return {rho, typeKey, dict};
}

function ensureTypeSelectedForDistribution(){
  const tstate=app.trailerState;
  if(!tstate || tstate.type!=='tanker') return true;
  const msg='Укажите тип груза и плотность';
  const typeKey=$('singleType').value;
  if(!typeKey){ showToast(msg); return false; }
  const rho=getSingleEffectiveRho();
  if(!isFinite(rho) || rho<=0){ showToast(msg); return false; }
  if(!tstate.single) tstate.single=defaultSingle();
  tstate.single.typeKey=typeKey;
  if(isFinite(rho) && rho>0){ tstate.single.rho=rho; }
  tstate.single.adr=$('singleAdr').value||tstate.single.adr||'Не знаю';
  return true;
}

function getSingleEffectiveRho(){
  const tstate=app.trailerState; if(!tstate) return null;
  const single=tstate.single||defaultSingle();
  let rho=parseFloat($('singleRho').value);
  if(isFinite(rho) && rho>0){ single.rho=rho; return rho; }
  const dict=getAllProducts().find(d=>d.key===single.typeKey);
  if(dict?.rho>0){
    single.rho=dict.rho;
    single.rhoManual=false;
    $('singleRho').value=dict.rho;
    return dict.rho;
  }
  single.rho=null;
  return null;
}

function updateSingleTotalsFromValues(liters, kg, rho, typeKey, adr){
  const tstate=app.trailerState; if(!tstate) return;
  if(!tstate.single) tstate.single=defaultSingle();
  const single=tstate.single;
  if(typeKey!==undefined) single.typeKey=typeKey;
  if(adr!==undefined) single.adr=adr;
  if(isFinite(rho) && rho>0){ single.rho=rho; }
  else if(rho===null) single.rho=null;
  single.liters=isFinite(liters)?liters:0;
  single.kg=isFinite(kg)?kg:0;
  single.tons=single.kg/1000;
  single.m3=single.liters/1000;
  buildSingleRow(tstate);
  saveState();
}

function handleSingleChange(source){
  if(singleUpdating) return;
  const tstate=app.trailerState; if(!tstate || tstate.type!=='tanker') return;
  if(!tstate.single) tstate.single=defaultSingle();
  const single=tstate.single;
  if(source==='type'){
    const typeKey=$('singleType').value||'';
    single.typeKey=typeKey;
    const dict=getAllProducts().find(d=>d.key===typeKey);
    if(dict){ single.rho=dict.rho; single.rhoManual=false; $('singleRho').value=dict.rho; }
    else { single.rho=null; single.rhoManual=false; $('singleRho').value=''; }
    if(!single.adr) single.adr='Не знаю';
    app.fitStats=null;
    const liters=isFinite(single.liters)?single.liters:0;
    const rhoVal=(isFinite(single.rho)&&single.rho>0)?single.rho:null;
    const kg=rhoVal?liters*rhoVal:0;
    updateSingleTotalsFromValues(liters, kg, rhoVal, single.typeKey, single.adr);
    if(app.trailerState?.allSame){
      applySingleToRows(app.trailerState);
      recalc();
    }
    return;
  }
  if(source==='adr'){
    single.adr=$('singleAdr').value||'Не знаю';
    app.fitStats=null;
    updateSingleTotalsFromValues(single.liters, single.kg, single.rho, single.typeKey, single.adr);
    if(app.trailerState?.allSame) applySingleToRows(app.trailerState);
    return;
  }
  if(source==='rho'){
    const rho=parseFloat($('singleRho').value);
    if(isFinite(rho) && rho>0){ single.rho=rho; single.rhoManual=true; }
    else { single.rho=null; single.rhoManual=true; }
    app.fitStats=null;
    const liters=isFinite(single.liters)?single.liters:0;
    const rhoVal=(isFinite(single.rho)&&single.rho>0)?single.rho:null;
    const kg=rhoVal?liters*rhoVal:0;
    updateSingleTotalsFromValues(liters, kg, rhoVal, single.typeKey, single.adr);
    if(app.trailerState?.allSame){
      applySingleToRows(app.trailerState);
      recalc();
    }
    return;
  }
  let rho=single.rho;
  if(!isFinite(rho) || rho<=0) rho=getSingleEffectiveRho();
  let liters=isFinite(single.liters)?single.liters:0;
  let kg=isFinite(single.kg)?single.kg:0;
  let tons=isFinite(single.tons)?single.tons:0;
  let m3=isFinite(single.m3)?single.m3:0;
  if(source==='L'){
    const raw=$('singleL').value.trim();
    if(raw===''){ liters=0; kg=0; tons=0; m3=0; }
    else {
      const val=parseFloat(raw);
      if(isFinite(val)){
        if(val<0){ liters=0; kg=0; tons=0; m3=0; $('singleL').value='0'; }
        else { liters=val; kg=rho*liters; tons=kg/1000; m3=liters/1000; }
      }
    }
  } else if(source==='T'){
    const raw=$('singleT').value.trim();
    if(raw===''){ liters=0; kg=0; tons=0; m3=0; }
    else {
      const val=parseFloat(raw);
      if(isFinite(val)){
        if(val<0){ tons=0; kg=0; liters=0; m3=0; $('singleT').value='0'; }
        else { tons=val; kg=tons*1000; liters=rho>0?kg/rho:0; m3=liters/1000; }
      }
    }
  } else if(source==='M3'){
    const raw=$('singleM3').value.trim();
    if(raw===''){ liters=0; kg=0; tons=0; m3=0; }
    else {
      const val=parseFloat(raw);
      if(isFinite(val)){
        if(val<0){ m3=0; liters=0; kg=0; tons=0; $('singleM3').value='0'; }
        else { m3=val; liters=m3*1000; kg=rho*liters; tons=kg/1000; }
      }
    }
  }
  app.fitStats=null;
  updateSingleTotalsFromValues(liters, kg, rho, single.typeKey, single.adr);
}

function applyDistributionMass(totalKg){
  if(app.trailerState?.type!=='tanker') return;
  const tb=$('tankBody'); const rows=[...tb.querySelectorAll('tr')]; if(rows.length===0) return;
  const rhoPanel=getSingleEffectiveRho();
  if(!isFinite(rhoPanel) || rhoPanel<=0){ showToast('Укажите тип груза и плотность'); return; }
  const typeKey=$('singleType').value||'';
  const adrVal=$('singleAdr').value||'Не знаю';
  const sameCargo=!!app.trailerState.allSame;
  const single=app.trailerState.single||defaultSingle();
  distributing=true;
  app.fitStats=null;
  let remainingKg=Math.max(totalKg,0);
  let addedKg=0, addedL=0;
  rows.forEach((tr,i)=>{
    const cap=app.trailerState.caps[i]||0;
    const rowState=app.trailerState.rows[i]||defaultRow();
    const currentLiters=isFinite(rowState.liters)?rowState.liters:0;
    const freeLiters=Math.max(cap-currentLiters,0);
    if(freeLiters<=0 || remainingKg<=0){ app.trailerState.rows[i]=rowState; return; }
    const maxKg=rhoPanel>0?freeLiters*rhoPanel:0;
    const useKg=Math.min(remainingKg, maxKg);
    if(useKg<=0){ app.trailerState.rows[i]=rowState; return; }
    const addLiters=rhoPanel>0?useKg/rhoPanel:0;
    const newLiters=currentLiters+addLiters;
    tr.dataset.lastInput='liters';
    tr.dataset.exactL=newLiters;
    const inpL=tr.querySelector('.inpL'); if(inpL) inpL.value=String(roundLiters(newLiters));
    const inpT=tr.querySelector('.inpT'); if(inpT) inpT.value='';
    const inpM3=tr.querySelector('.inpM3'); if(inpM3) inpM3.value='';
    if(sameCargo){
      const sel=tr.querySelector('.selType'); if(sel) sel.value=typeKey;
      const adrSel=tr.querySelector('.selAdr'); if(adrSel) adrSel.value=adrVal;
      const rhoInp=tr.querySelector('.inpRho'); if(rhoInp) rhoInp.value=rhoPanel;
      rowState.typeKey=typeKey;
      rowState.adr=adrVal;
      rowState.rho=rhoPanel;
      rowState.rhoManual=!!single.rhoManual;
    }
    rowState.lastInput='liters';
    app.trailerState.rows[i]=rowState;
    remainingKg=Math.max(remainingKg-useKg,0);
    addedKg+=useKg;
    addedL+=addLiters;
  });
  distributing=false;
  const leftKg=Math.max(remainingKg,0);
  const leftL=rhoPanel>0?leftKg/rhoPanel:0;
  app.fitStats={fitL:addedL, fitKg:addedKg, leftL, leftKg};
  single.typeKey=typeKey;
  single.adr=adrVal;
  if(isFinite(rhoPanel) && rhoPanel>0){ single.rho=rhoPanel; }
  if(!sameCargo){
    single.liters=addedL;
    single.kg=addedKg;
    single.tons=addedKg/1000;
    single.m3=addedL/1000;
  }
  app.trailerState.single=single;
  recalc();
  if(app.trailerState.allSame){ syncSingleFromRows(app.trailerState); }
  buildSingleRow(app.trailerState);
  saveState();
}

function applyDistributionLiters(totalLiters){
  if(app.trailerState?.type!=='tanker') return;
  const tb=$('tankBody'); const rows=[...tb.querySelectorAll('tr')]; if(rows.length===0) return;
  const rhoPanel=getSingleEffectiveRho();
  if(!isFinite(rhoPanel) || rhoPanel<=0){ showToast('Укажите тип груза и плотность'); return; }
  const typeKey=$('singleType').value||'';
  const adrVal=$('singleAdr').value||'Не знаю';
  const sameCargo=!!app.trailerState.allSame;
  const single=app.trailerState.single||defaultSingle();
  distributing=true;
  app.fitStats=null;
  let remainingL=Math.max(totalLiters,0);
  let addedL=0, addedKg=0;
  rows.forEach((tr,i)=>{
    const cap=app.trailerState.caps[i]||0;
    const rowState=app.trailerState.rows[i]||defaultRow();
    const currentLiters=isFinite(rowState.liters)?rowState.liters:0;
    const freeLiters=Math.max(cap-currentLiters,0);
    if(freeLiters<=0 || remainingL<=0){ app.trailerState.rows[i]=rowState; return; }
    const useL=Math.min(remainingL, freeLiters);
    if(useL<=0){ app.trailerState.rows[i]=rowState; return; }
    const newLiters=currentLiters+useL;
    tr.dataset.lastInput='liters';
    tr.dataset.exactL=newLiters;
    const inpL=tr.querySelector('.inpL'); if(inpL) inpL.value=String(roundLiters(newLiters));
    const inpT=tr.querySelector('.inpT'); if(inpT) inpT.value='';
    const inpM3=tr.querySelector('.inpM3'); if(inpM3) inpM3.value='';
    if(sameCargo){
      const sel=tr.querySelector('.selType'); if(sel) sel.value=typeKey;
      const adrSel=tr.querySelector('.selAdr'); if(adrSel) adrSel.value=adrVal;
      const rhoInp=tr.querySelector('.inpRho'); if(rhoInp) rhoInp.value=rhoPanel;
      rowState.typeKey=typeKey;
      rowState.adr=adrVal;
      rowState.rho=rhoPanel;
      rowState.rhoManual=!!single.rhoManual;
    }
    rowState.lastInput='liters';
    app.trailerState.rows[i]=rowState;
    remainingL=Math.max(remainingL-useL,0);
    addedL+=useL;
    addedKg+=useL*rhoPanel;
  });
  distributing=false;
  const leftL=Math.max(remainingL,0);
  const leftKg=rhoPanel>0?leftL*rhoPanel:0;
  app.fitStats={fitL:addedL, fitKg:addedKg, leftL, leftKg};
  single.typeKey=typeKey;
  single.adr=adrVal;
  if(isFinite(rhoPanel) && rhoPanel>0){ single.rho=rhoPanel; }
  if(!sameCargo){
    single.liters=addedL;
    single.kg=addedKg;
    single.tons=addedKg/1000;
    single.m3=addedL/1000;
  }
  app.trailerState.single=single;
  recalc();
  if(app.trailerState.allSame){ syncSingleFromRows(app.trailerState); }
  buildSingleRow(app.trailerState);
  saveState();
}

function handleDistributeMass(){
  if(!ensureTypeSelectedForDistribution()) return;
  const totalT=num($('totalMassT').value, NaN);
  if(!isFinite(totalT) || totalT<=0){ showToast('Введите число больше 0'); return; }
  applyDistributionMass(totalT*1000);
}
function handleDistributeM3(){
  if(!ensureTypeSelectedForDistribution()) return;
  const totalM3=num($('totalVolM3').value, NaN);
  if(!isFinite(totalM3) || totalM3<=0){ showToast('Введите число больше 0'); return; }
  applyDistributionLiters(totalM3*1000);
}
/* ========== Platform table ========== */
function buildPlatRows(state){
  const tb=$('platBody'); tb.innerHTML='';
  const n=state.positions||4;
  for(let i=0;i<n;i++){
    const tr=document.createElement('tr');
    const m=state.masses?.[i]||0;
    tr.innerHTML=`<td><span class="pill">#${i+1}</span></td><td><input class="inpMass" type="number" value="${m}"></td>`;
    tb.appendChild(tr);
  }
}

/* ===================== App state ===================== */
let app={
  tractorAxles:2,
  tractorPlate:null,
  selectedTrailerId:null,
  trailerState:null,
  distanceMode:'manual', // 'manual' | 'maps'
  provider:'google',     // 'google' | 'yandex'
  distanceKm:0,
  ratePerKm:0,
  trips:1,
  routeFrom:'',
  routeTo:'',
  fitStats:null
};
function loadState(){
  let loaded=null;
  try{
    const raw=localStorage.getItem(LS_KEYS.state);
    if(raw) loaded=JSON.parse(raw);
    else if(LS_KEYS.legacyState){
      const legacy=localStorage.getItem(LS_KEYS.legacyState);
      if(legacy) loaded=JSON.parse(legacy);
    }
  }catch(e){}
  if(loaded) app=loaded;
  if(!app.fitStats) app.fitStats=null;
  if(app.trailerState?.type==='tanker'){
    if(!Array.isArray(app.trailerState.rows)) app.trailerState.rows=[];
    if(!Array.isArray(app.trailerState.caps)) app.trailerState.caps=[];
    if(typeof app.trailerState.allSame!=='boolean') app.trailerState.allSame=true;
    if(!app.trailerState.single) app.trailerState.single=defaultSingle();
    else app.trailerState.single={...defaultSingle(), ...app.trailerState.single};
    app.trailerState.rows=app.trailerState.rows.map(r=>{
      const row={ ...defaultRow(), ...r };
      if(!row.adr) row.adr='Не знаю';
      if(!row.lastInput) row.lastInput='liters';
      if(!isFinite(row.m3) && isFinite(row.liters)) row.m3=row.liters/1000;
      if(!isFinite(row.tons) && isFinite(row.kg)) row.tons=row.kg/1000;
      if((!isFinite(row.kg) || row.kg===0) && isFinite(row.liters) && isFinite(row.rho) && row.rho>0) row.kg=row.liters*row.rho;
      return row;
    });
    if(!app.trailerState.single.adr) app.trailerState.single.adr='Не знаю';
    if(!isFinite(app.trailerState.single.m3) && isFinite(app.trailerState.single.liters)) app.trailerState.single.m3=app.trailerState.single.liters/1000;
    if(typeof app.trailerState.single.rhoManual!=='boolean') app.trailerState.single.rhoManual=false;
  }
}
function saveState(){
  localStorage.setItem(LS_KEYS.state, JSON.stringify(app));
  if(LS_KEYS.legacyState) localStorage.removeItem(LS_KEYS.legacyState);
}

/* ===================== Init/Render ===================== */
function defaultRow(){ return {typeKey:'', adr:'Не знаю', rho:null, liters:0, kg:0, tons:0, m3:0, rhoManual:false, lastInput:'liters'}; }
function defaultSingle(){ return {typeKey:'', adr:'Не знаю', rho:null, liters:0, kg:0, tons:0, m3:0, rhoManual:false}; }
function tankerFromPreset(compartments){
  return { caps:[...compartments], rows: compartments.map(()=>defaultRow()), allSame:true, single:defaultSingle() };
}
function ensureRowsMatchCaps(state){
  const need=state.caps.length;
  while(state.rows.length<need) state.rows.push(defaultRow());
  while(state.rows.length>need) state.rows.pop();
  if(!state.single) state.single=defaultSingle();
}

function syncSingleFromRows(state){
  if(!state.single) state.single=defaultSingle();
  const single=state.single;
  const totalLiters=state.rows.reduce((sum,row)=>sum+(isFinite(row.liters)?row.liters:0),0);
  const totalKg=state.rows.reduce((sum,row)=>sum+(isFinite(row.kg)?row.kg:0),0);
  single.liters=totalLiters;
  single.kg=totalKg;
  single.tons=totalKg/1000;
  single.m3=totalLiters/1000;
  const first=state.rows.find(r=>r.typeKey);
  if(!single.typeKey && first?.typeKey) single.typeKey=first.typeKey;
  if((!single.adr || single.adr==='Не знаю') && first?.adr) single.adr=first.adr;
  if(!single.rhoManual && isFinite(first?.rho) && first.rho>0) single.rho=first.rho;
  if((!isFinite(single.rho)||single.rho<=0) && totalLiters>0 && totalKg>0) single.rho=totalKg/totalLiters;
  return single;
}
function applySingleToRows(state){
  if(!state?.allSame) return;
  const rows=[...$('tankBody')?.querySelectorAll('tr')||[]];
  const single=state.single||defaultSingle();
  const typeKey=single.typeKey||'';
  const adr=single.adr||'Не знаю';
  const rho=(isFinite(single.rho)&&single.rho>0)?single.rho:null;
  const rhoManual=!!single.rhoManual;
  rows.forEach((tr,i)=>{
    const rowState=state.rows[i]||defaultRow();
    if(typeKey){
      const sel=tr.querySelector('.selType');
      if(sel) sel.value=typeKey;
      rowState.typeKey=typeKey;
    }
    const adrSel=tr.querySelector('.selAdr');
    if(adrSel){
      adrSel.value=adr;
      rowState.adr=adrSel.value||'Не знаю';
    }
    const rhoInp=tr.querySelector('.inpRho');
    if(rhoInp){
      if(rho) rhoInp.value=rho;
      else if(!rhoManual) rhoInp.value='';
    }
    if(rho){
      rowState.rho=rho;
      rowState.rhoManual=rhoManual;
    }
    state.rows[i]=rowState;
  });
}
function selectTrailer(id){
  const all=getAllTrailers();
  const t=all.find(x=>x.id===id) || all[0];
  app.selectedTrailerId=t.id;
  if(t.type==='tanker'){ app.trailerState={type:'tanker', ...tankerFromPreset(t.compartmentsLiters)}; }
  else { app.trailerState={type:'platform', positions:t.positions||4, masses:Array(t.positions||4).fill(0)}; }
  app.fitStats=null;
  renderCurrent(); saveState();
}
function renderCurrent(){
  const t=getAllTrailers().find(x=>x.id===app.selectedTrailerId);
  setTrailerInfo(t);
  renderTrailerSelect(app.selectedTrailerId);
  renderTractorSelect(app.tractorPlate);
  if(!app.tractorPlate){ const allTr=getAllTrucks(); app.tractorPlate=allTr[0]; }
  const storedAx=getTruckAxles(app.tractorPlate); app.tractorAxles=storedAx||app.tractorAxles||2; $('tractorAxles').value=String(app.tractorAxles||2);
  $('tractorSelect').value=app.tractorPlate;

  $('provider').value=app.provider||'google';
  $('distanceMode').value=app.distanceMode||'manual';

  $('distanceKm').value=app.distanceKm||'';
  $('ratePerKm').value=app.ratePerKm||'';
  $('trips').value=app.trips||1;

  $('routeFrom').value=app.routeFrom||'';
  $('routeTo').value=app.routeTo||'';
  $('mapsNote').style.display=(app.distanceMode==='maps')?'block':'none';

  if(app.trailerState?.type==='tanker'){
    const tstate=app.trailerState;
    $('tankSection').style.display='block'; $('platformSection').style.display='none';
    ensureRowsMatchCaps(tstate); buildTankRows(tstate); buildSingleRow(tstate); applySingleToRows(tstate);
    $('chkAllSame').checked=!!tstate.allSame;
    const tbl=document.querySelector('#tankSection table'); if(tbl) tbl.style.display='table';
  } else {
    $('tankSection').style.display='none'; $('platformSection').style.display='block'; buildPlatRows(app.trailerState);
    app.fitStats=null;
  }
  recalc();
}

/* ===================== Recalc ===================== */
function recalc(){
  const tstate=app.trailerState; const warns=[]; let sumL=0, sumKg=0;
  if($('tractorSelect')) app.tractorPlate=$('tractorSelect').value||app.tractorPlate;

  if(tstate.type==='tanker'){
    const tb=$('tankBody'); const rows=[...tb.querySelectorAll('tr')];
    rows.forEach((tr,i)=>{
      const rowObj=tstate.rows[i]||defaultRow();
      const typeKey=tr.querySelector('.selType').value||'';
      rowObj.typeKey=typeKey;
      const dict=typeKey? getAllProducts().find(d=>d.key===typeKey) : null;

      const rhoInp=tr.querySelector('.inpRho');
      let rho=parseFloat(rhoInp.value);
      if((!isFinite(rho) || rho<=0)){
        if(!rowObj.rhoManual && dict?.rho>0){ rho=dict.rho; rhoInp.value=dict.rho; }
        else { rho=NaN; }
      }
      rowObj.rho = (isFinite(rho) && rho>0) ? rho : null;

      const adrSel=tr.querySelector('.selAdr');
      if(adrSel && !adrSel.value) adrSel.value='Не знаю';
      rowObj.adr=adrSel?.value||'Не знаю';

      const inpL=tr.querySelector('.inpL');
      const inpT=tr.querySelector('.inpT');
      const inpM3=tr.querySelector('.inpM3');
      let source=tr.dataset.lastInput||rowObj.lastInput||'liters';
      if(source!=='tons' && source!=='liters') source='liters';
      const rawL=inpL?.value?.trim()||'';
      const rawT=inpT?.value?.trim()||'';
      const effectiveRho=(isFinite(rowObj.rho)&&rowObj.rho>0)? rowObj.rho : (dict?.rho>0?dict.rho:NaN);
      let liters=0, tons=0, kg=0, m3=0;
      let empty=true;

      if(source==='tons'){
        if(rawT===''){
          empty=true;
          if(inpL) inpL.value='';
          if(inpM3) inpM3.value='';
          if(inpT) inpT.value='';
          delete tr.dataset.exactL;
        } else {
          let parsed=parseFloat(rawT);
          if(!isFinite(parsed)) parsed=0;
          if(parsed<0){
            warns.push(`Отсек #${i+1}: отрицательные значения`);
            parsed=0;
            if(inpT) inpT.value='0.000';
          }
          tons=parsed;
          kg=tons*1000;
          liters=(isFinite(effectiveRho)&&effectiveRho>0)? kg/effectiveRho : 0;
          m3=liters/1000;
          if(inpL) inpL.value = liters===0 ? '0' : String(roundLiters(liters));
          if(inpT) inpT.value = tons.toFixed(3);
          if(inpM3) inpM3.value = m3.toFixed(3);
          tr.dataset.exactL=liters;
          empty=false;
        }
      } else {
        if(rawL===''){
          empty=true;
          if(inpT) inpT.value='';
          if(inpM3) inpM3.value='';
          delete tr.dataset.exactL;
        } else {
          let parsedExact;
          if(tr.dataset.exactL!==undefined){
            const exactVal=parseFloat(tr.dataset.exactL);
            if(isFinite(exactVal)) parsedExact=exactVal;
          }
          if(parsedExact===undefined){
            let parsed=parseFloat(rawL);
            if(!isFinite(parsed)) parsed=0;
            if(parsed<0){
              warns.push(`Отсек #${i+1}: отрицательные значения`);
              parsed=0;
            }
            parsedExact=parsed;
          }
          liters=parsedExact;
          kg=(isFinite(effectiveRho)&&effectiveRho>0)? liters*effectiveRho : 0;
          tons=kg/1000;
          m3=liters/1000;
          const displayLiters=roundLiters(liters);
          if(inpL) inpL.value = String(displayLiters);
          if(inpT) inpT.value = tons.toFixed(3);
          if(inpM3) inpM3.value = m3.toFixed(3);
          tr.dataset.exactL=liters;
          empty=false;
        }
      }

      if(empty){ liters=0; kg=0; tons=0; m3=0; }

      tr.dataset.lastInput=source;
      rowObj.lastInput=source;
      rowObj.liters=liters;
      rowObj.kg=kg;
      rowObj.tons=tons;
      rowObj.m3=m3;
      tstate.rows[i]=rowObj;

      const cap=tstate.caps[i]??Infinity;
      if(liters>cap+1e-6) warns.push(`Переполнение #${i+1}: ${Math.round(liters)} л > лимита ${cap} л`);

      sumL+=liters; sumKg+=kg;
    });

    const totalL=isFinite(sumL)?sumL:0;
    const totalKg=isFinite(sumKg)?sumKg:0;
    const leftL=Math.max(0, isFinite(app.fitStats?.leftL)?app.fitStats.leftL:0);
    const leftKg=Math.max(0, isFinite(app.fitStats?.leftKg)?app.fitStats.leftKg:0);
    if(app.fitStats){ app.fitStats.fitL=sumL; app.fitStats.fitKg=sumKg; }
    const totalLine=
      `Всего: ${fmtL(totalL)} / ${fmtKg(totalKg)} / ${fmtT(totalKg/1000)} / ${fmtM3(totalL/1000)} · `+
      `Не поместилось: ${fmtL(leftL)} / ${fmtKg(leftKg)} / ${fmtT(leftKg/1000)} / ${fmtM3(leftL/1000)}`;
    const fitBox=$('fitSummary');
    fitBox.textContent=totalLine;

  } else {
    const tb=$('platBody'); const rows=[...tb.querySelectorAll('tr')];
    let masses=[]; rows.forEach((tr,i)=>{ let m=num(tr.querySelector('.inpMass').value,0); if(m<0){warns.push(`Позиция #${i+1}: отрицательная масса`); m=0;} masses[i]=m; sumKg+=m; });
    tstate.masses=masses; sumL=NaN;
    $('fitSummary').textContent='—';
  }

  $('sumL').textContent = isNaN(sumL)? '—' : fmtL(sumL);
  $('sumT').textContent = fmtT(sumKg/1000);

  const ul=$('warnList'); ul.innerHTML=''; if(warns.length===0){ const li=document.createElement('li'); li.textContent='Ошибок не обнаружено.'; ul.appendChild(li);} else { warns.forEach(w=>{ const li=document.createElement('li'); li.innerHTML=`<span class="warn">⚠</span> ${w}`; ul.appendChild(li); }); }

  app.distanceKm=num($('distanceKm').value, app.distanceKm||0);
  app.ratePerKm=num($('ratePerKm').value, app.ratePerKm||0);
  app.trips=parseInt($('trips').value)||app.trips||1;
  const cost=app.distanceKm*app.ratePerKm*app.trips;
  $('kpiDistance').textContent = (isFinite(app.distanceKm)&&app.distanceKm>0)? (Math.round(app.distanceKm).toLocaleString('ru-RU')+' км'):'—';
  $('kpiRate').textContent = (isFinite(app.ratePerKm)&&app.ratePerKm>0)? (app.ratePerKm.toLocaleString('ru-RU')+' ₽/км'):'—';
  $('kpiTrips').textContent = String(app.trips);
  $('kpiCost').textContent = (isFinite(cost)&&cost>0)? cost.toLocaleString('ru-RU')+' ₽' : '—';

  // brief
  const t=getAllTrailers().find(x=>x.id===app.selectedTrailerId);
  const totalLine = isNaN(sumL)
    ? `Итоги: —`
    : `Итоги: ${fmtL(sumL)} / ${fmtKg(sumKg)} / ${fmtT(sumKg/1000)} / ${fmtM3(sumL/1000)}`;
  let lines=[`Прицеп: ${t?.name||''} (${t?.type==='tanker'?'цистерна':'площадка'})`, `Тягач: ${app.tractorPlate||'—'} (${app.tractorAxles} оси)`, totalLine];
  if(tstate.type==='tanker'){
    if(tstate.allSame){
      const single=tstate.single||defaultSingle();
      const d=getAllProducts().find(x=>x.key===single.typeKey);
      const label=d?.label||single.typeKey||'—';
      const litersText=isNaN(sumL)?'—':fmtL(sumL);
      const tonsText=isNaN(sumKg)?'—':fmtT(sumKg/1000);
      const m3Text=isNaN(sumL)?'—':fmtM3(sumL/1000);
      lines.push(`#1: ${label}, ADR ${single.adr||'Не знаю'}, ρ=${isFinite(single.rho)?single.rho:'—'}, ${litersText} / ${tonsText} / ${m3Text}`);
    } else {
      tstate.rows.forEach((r,i)=>{
        const d=getAllProducts().find(x=>x.key===r.typeKey);
        const label=d?.label||r.typeKey||'—';
        const litersText=isFinite(r.liters)?fmtL(r.liters):'—';
        const kgVal=isFinite(r.kg)?r.kg: (isFinite(r.liters)&&isFinite(r.rho)? r.liters*r.rho : NaN);
        const tonsText=isFinite(kgVal)?fmtT(kgVal/1000):'—';
        const m3Text=isFinite(r.liters)?fmtM3(r.liters/1000):'—';
        lines.push(`#${i+1}: ${label}, ADR ${r.adr}, ρ=${isFinite(r.rho)?r.rho:'—'}, ${litersText} / ${tonsText} / ${m3Text}`);
      });
    }
  } else { (tstate.masses||[]).forEach((kg,i)=>{ lines.push(`#${i+1}: ${(kg/1000).toFixed(3)} т`); }); }
  const routeStr=(app.routeFrom||app.routeTo)? `Маршрут: ${app.routeFrom||'?'} → ${app.routeTo||'?'}`:'';
  const costStr=(isFinite(cost)&&cost>0)? `Стоимость: ${cost.toLocaleString('ru-RU')} ₽ (${app.distanceKm} км × ${app.ratePerKm} ₽/км × ${app.trips} рейс.)`:'';
  if(routeStr) lines.push(routeStr); if(costStr) lines.push(costStr);
  $('brief').value = lines.join('\n');

  saveState();
}

/* ===================== Events ===================== */
function bind(){
  $('trailerSelect').addEventListener('change', e=>selectTrailer(e.target.value));
  $('tractorSelect').addEventListener('change', e=>{ app.tractorPlate=e.target.value; const ax=getTruckAxles(app.tractorPlate)||2; app.tractorAxles=ax; $('tractorAxles').value=String(ax); saveState(); recalc(); });
  $('tractorAxles').addEventListener('change', e=>{ const ax=parseInt(e.target.value)||2; app.tractorAxles=ax; setTruckAxles(app.tractorPlate, ax); saveState(); recalc(); });

  $('provider').addEventListener('change', e=>{ app.provider=e.target.value; saveState(); maybeInitMaps(); });
  $('distanceMode').addEventListener('change', e=>{ app.distanceMode=e.target.value; $('mapsNote').style.display=(app.distanceMode==='maps')?'block':'none'; saveState(); maybeInitMaps(); });

  const resetBtn=$('resetPreset');
  if(resetBtn) resetBtn.addEventListener('click', ()=>selectTrailer(app.selectedTrailerId));
  $('copyBrief').addEventListener('click', ()=>navigator.clipboard.writeText($('brief').value));
  $('addTrailer').addEventListener('click', openModal);
  $('addTruck').addEventListener('click', openTruckModal);

  ['distanceKm','ratePerKm','trips','routeFrom','routeTo'].forEach(id=>{
    $(id).addEventListener('input', ()=>{
      app.distanceKm=num($('distanceKm').value,0);
      app.ratePerKm=num($('ratePerKm').value,0);
      app.trips=parseInt($('trips').value)||1;
      app.routeFrom=$('routeFrom').value;
      app.routeTo=$('routeTo').value;
      saveState(); recalc();
    });
  });

  $('tankBody').addEventListener('input',(e)=>{
    const tr=e.target.closest('tr');
    if(tr){
      const idx=parseInt(tr.dataset.index,10);
      if(e.target.classList.contains('inpRho') && app.trailerState?.rows?.[idx]) app.trailerState.rows[idx].rhoManual=true;
      if(e.target.classList.contains('inpL')){ tr.dataset.lastInput='liters'; delete tr.dataset.exactL; }
      else if(e.target.classList.contains('inpT')){ tr.dataset.lastInput='tons'; delete tr.dataset.exactL; }
    }
    if(!distributing) app.fitStats=null;
    recalc();
  });
  $('platBody').addEventListener('input', ()=>{ recalc(); });

  $('singleType').addEventListener('change', ()=>handleSingleChange('type'));
  $('singleAdr').addEventListener('change', ()=>handleSingleChange('adr'));
  $('singleRho').addEventListener('input', ()=>handleSingleChange('rho'));
  $('singleL').addEventListener('input', ()=>handleSingleChange('L'));
  $('singleT').addEventListener('input', ()=>handleSingleChange('T'));
  $('singleM3').addEventListener('input', ()=>handleSingleChange('M3'));

  $('tankBody').addEventListener('change',(e)=>{
    const tr=e.target.closest('tr'); if(!tr) return;
    if(e.target.classList.contains('selType')){
      const idx=parseInt(tr.dataset.index,10);
      const row=app.trailerState?.rows?.[idx];
      const typeKey=e.target.value||'';
      if(row) row.typeKey=typeKey;
      const dict=getAllProducts().find(d=>d.key===typeKey);
      if(dict){ tr.querySelector('.inpRho').value=dict.rho; if(row){ row.rho=dict.rho; row.rhoManual=false; } }
      else if(row){ row.rho=null; row.rhoManual=false; tr.querySelector('.inpRho').value=''; }
      const adrSel=tr.querySelector('.selAdr'); if(adrSel && !adrSel.value) adrSel.value='Не знаю';
      tr.dataset.lastInput='liters';
      delete tr.dataset.exactL;
      app.fitStats=null;
      recalc();
    } else if(e.target.classList.contains('selAdr') || e.target.classList.contains('inpRho')){
      app.fitStats=null;
      recalc();
    }
  });

  $('chkAllSame').addEventListener('change',(e)=>{
    if(app.trailerState?.type!=='tanker') return;
    const checked=!!e.target.checked;
    if(app.trailerState.allSame===checked) return;
    app.trailerState.allSame=checked;
    app.fitStats=null;
    if(checked){
      syncSingleFromRows(app.trailerState);
      buildSingleRow(app.trailerState);
      applySingleToRows(app.trailerState);
    } else {
      buildSingleRow(app.trailerState);
    }
    recalc();
  });

  $('fillMax').addEventListener('click',()=>{
    if(app.trailerState?.type!=='tanker') return;
    const tb=$('tankBody');
    app.fitStats=null;
    let totalLiters=0;
    [...tb.querySelectorAll('tr')].forEach((tr,i)=>{
      const cap=app.trailerState.caps[i]||0;
      tr.dataset.lastInput='liters';
      const inpL=tr.querySelector('.inpL'); if(inpL) inpL.value=cap>0?String(cap):'0';
      const inpT=tr.querySelector('.inpT'); if(inpT) inpT.value='';
      const inpM3=tr.querySelector('.inpM3'); if(inpM3) inpM3.value='';
      tr.dataset.exactL=cap>0?cap:0;
      if(cap>0) totalLiters+=cap;
    });
    if(app.trailerState.allSame){
      const rhoVal=getSingleEffectiveRho();
      const safeRho=(isFinite(rhoVal)&&rhoVal>0)?rhoVal:null;
      const typeKey=$('singleType').value||'';
      const adrVal=$('singleAdr').value||'Не знаю';
      const kgVal=safeRho?totalLiters*safeRho:0;
      updateSingleTotalsFromValues(totalLiters, kgVal, safeRho, typeKey, adrVal);
    }
    recalc();
  });
  $('clearAll').addEventListener('click',()=>{
    if(app.trailerState?.type!=='tanker') return;
    const tb=$('tankBody');
    app.fitStats=null;
    [...tb.querySelectorAll('tr')].forEach((tr)=>{
      tr.dataset.lastInput='liters';
      const inpL=tr.querySelector('.inpL'); if(inpL) inpL.value='';
      const inpT=tr.querySelector('.inpT'); if(inpT) inpT.value='';
      const inpM3=tr.querySelector('.inpM3'); if(inpM3) inpM3.value='';
      delete tr.dataset.exactL;
    });
    if(app.trailerState.allSame){
      const typeKey=$('singleType').value||'';
      const adrVal=$('singleAdr').value||'Не знаю';
      updateSingleTotalsFromValues(0,0,app.trailerState.single?.rho||null,typeKey,adrVal);
    } else {
      const single=app.trailerState.single||defaultSingle();
      single.liters=0; single.kg=0; single.tons=0; single.m3=0;
      app.trailerState.single=single;
      buildSingleRow(app.trailerState);
    }
    recalc();
  });

  $('btnDistributeMass').addEventListener('click', handleDistributeMass);
  $('btnDistributeM3').addEventListener('click', handleDistributeM3);

  // модалка прицепа
  $('m_type').addEventListener('change', e=>{ const isPlat=e.target.value==='platform'; $('m_positions_wrap').style.display=isPlat?'block':'none'; $('m_caps_wrap').style.display=isPlat?'none':'block'; });
  $('m_cancel').addEventListener('click', closeModal);
  $('m_save').addEventListener('click', saveModalTrailer);

  // модалка тягача
  $('mt_cancel').addEventListener('click', closeTruckModal);
  $('mt_save').addEventListener('click', saveTruck);

  // модалка продукта
  $('mp_cancel').addEventListener('click', closeProductModal);
  $('mp_save').addEventListener('click', saveProductModal);

  // кастомный продукт
  $('btnAddProduct').addEventListener('click', openProductModal);

  // карты
  $('btnRoute').addEventListener('click', buildRoute);
  $('mapsKey').addEventListener('input', ()=>maybeInitMaps());

  // тесты
  $('runTests').addEventListener('click', runTests);
}

/* ===================== Modals ===================== */
function openModal(){ $('modal').classList.add('open'); }
function closeModal(){ $('modal').classList.remove('open'); }
function genId(name){ return name.replace(/\s+/g,'_'); }
function saveModalTrailer(){
  const name=$('m_name').value.trim(); if(!name){ alert('Укажи номер прицепа'); return; }
  const type=$('m_type').value; const axles=parseInt($('m_axles').value)||4; const tare=num($('m_tare').value, type==='platform'?5900:(axles===3?7300:7800));
  let obj;
  if(type==='platform'){
    const positions=parseInt($('m_positions').value)||4;
    obj={ id: genId(name), name, type, axles, tareKg: tare, positions };
  } else {
    const capsStr=$('m_caps').value.trim(); const caps=capsStr? capsStr.split('/').map(s=>parseInt(s.replace(/\s+/g,''))||0) : [10000,8000,9000];
    obj={ id: genId(name), name, type, axles, tareKg: tare, compartmentsLiters: caps };
  }
  const custom=JSON.parse(localStorage.getItem(LS_KEYS.custom)||'[]');
  if(BASE_TRAILERS.find(x=>x.id===obj.id)) obj.id = obj.id+'_custom';
  custom.push(obj); localStorage.setItem(LS_KEYS.custom, JSON.stringify(custom));
  renderTrailerSelect(app.selectedTrailerId); closeModal();
}

function openTruckModal(){ $('modalTruck').classList.add('open'); }
function closeTruckModal(){ $('modalTruck').classList.remove('open'); }
function saveTruck(){
  const plate=$('mt_plate').value.trim(); if(!plate){ alert('Введи госномер'); return; }
  const axles=parseInt($('mt_axles').value)||2;
  const list = JSON.parse(localStorage.getItem(LS_KEYS.trucks)||'[]');
  if(!list.includes(plate)) list.push(plate);
  localStorage.setItem(LS_KEYS.trucks, JSON.stringify(list));
  setTruckAxles(plate, axles);
  renderTractorSelect(plate);
  $('tractorSelect').value=plate;
  $('tractorAxles').value=String(axles);
  app.tractorPlate=plate; app.tractorAxles=axles; saveState();
  closeTruckModal();
}

function openProductModal(){ $('modalProduct').classList.add('open'); $('mp_name').value=''; $('mp_rho').value=''; $('mp_adr').value='Не знаю'; }
function closeProductModal(){ $('modalProduct').classList.remove('open'); }
function saveProductModal(){
  const name=$('mp_name').value.trim(); if(!name){ showToast('Укажите название груза'); return; }
  const rho=parseFloat($('mp_rho').value); if(!isFinite(rho)||rho<=0){ showToast('Плотность должна быть > 0'); return; }
  const adr=$('mp_adr').value||'Не знаю';
  addCustomProduct(name, rho, adr);
  closeProductModal();
  renderCurrent();
  showToast('Груз добавлен в справочник');
}

/* ===================== Axle calc ===================== */
function syncAxleParamsFromTrailer(){
  const t = getAllTrailers().find(x=>x.id===app.selectedTrailerId);
  if(!t) return;
  $('axTl_ax').value = t.axles || 3;
  $('mp_ax').value   = t.tareKg || (t.axles===3?7300:7800);
  $('LA_ax').value = t.axles===3 ? 11800 : 12000;
  $('LB_ax').value = t.axles===3 ? 7400  : 7600;
  $('LC_ax').value = t.axles===3 ? 4400  : 4400;
  $('NTpp_ax').value = 2000;
}
function collectMassesAndPositions(){
  const LA = num($('LA_ax').value,12000);
  const tstate = app.trailerState; let kg=[], xs=[];
  if(tstate.type==='tanker'){
    const n=tstate.rows.length; for(let i=0;i<n;i++){ const row=tstate.rows[i]; const W=num(row.kg,0); const x=LA*(i+1)/(n+1); kg.push(W); xs.push(x); }
  } else {
    const n=tstate.masses.length; for(let i=0;i<n;i++){ const W=num(tstate.masses[i],0); const x=LA*(i+1)/(n+1); kg.push(W); xs.push(x); }
  }
  return {kg,xs};
}
function calcAxles(){
  const axTr=parseInt($('axTr_axle').value)||2; const axTl=parseInt($('axTl_ax').value)||3; const mT=8200;
  const LT=num($('LT_ax').value,3800), l2=num($('l2_ax').value,350), NT10=num($('NT10_ax').value,4200), NT20=num($('NT20_ax').value,4000);
  const mp=num($('mp_ax').value,7300), LA=num($('LA_ax').value,12000), LB=Math.max(1,num($('LB_ax').value,7600)), LC=num($('LC_ax').value,4400), NTpp=num($('NTpp_ax').value,2000);
  const {kg,xs}=collectMassesAndPositions();
  let Rk_sum=NTpp, Rb_sum=Math.max(0, mp-NTpp);
  for(let i=0;i<kg.length;i++){ const W=kg[i], x=xs[i]; const Rb=W*(x/LB); const Rk=W-Rb; Rk_sum+=Rk; Rb_sum+=Rb; }
  const R_front_from_pin=Rk_sum*(l2/LT), R_rear_from_pin=Rk_sum-R_front_from_pin;
  const Ax1=NT10+R_front_from_pin, Ax2_group=NT20+R_rear_from_pin;
  const perTrailerAxle=Rb_sum/axTl, perTractorRear=(axTr===3)?(Ax2_group/2):Ax2_group;
  const cargoSum=kg.reduce((a,b)=>a+b,0), G_total=mT+mp+cargoSum;
  $('G_total_ax').textContent=(G_total/1000).toFixed(2)+' т';
  $('Ax1_ax').textContent=Math.round(Ax1).toLocaleString('ru-RU')+' кг';
  $('Ax2_ax').textContent=(axTr===3? `${Math.round(perTractorRear).toLocaleString('ru-RU')} кг × 2` : Math.round(Ax2_group).toLocaleString('ru-RU')+' кг');
  $('AxTl_ax').textContent=`${Math.round(Rb_sum).toLocaleString('ru-RU')} кг (≈ ${Math.round(perTrailerAxle).toLocaleString('ru-RU')} кг × ${axTl})`;
  const warn=[]; if(Ax1>7500) warn.push('Передняя ось > 7.5 т'); if(axTr===2 && Ax2_group>11500) warn.push('Задняя ось тягача > 11.5 т'); if(axTr===3 && perTractorRear>11500) warn.push('Ось задней группы тягача > 11.5 т'); if(perTrailerAxle>10000) warn.push('Ось тележки прицепа > 10 т'); const w=$('axWarn_ax'); if(warn.length){ w.style.display='block'; w.textContent='Проверь нормативы: '+warn.join('; ');} else { w.style.display='none'; }
}
(function(){ const ids=['LT_ax','l2_ax','NT10_ax','NT20_ax','mp_ax','LA_ax','LB_ax','LC_ax','NTpp_ax','axTr_axle']; ids.forEach(id=>{ const el=$(id); if(el) el.addEventListener('input', calcAxles); }); const btn=$('recalcAxles'); if(btn) btn.addEventListener('click', calcAxles); })();
const _recalc_orig=recalc; recalc=function(){ _recalc_orig(); calcAxles(); };
const _selectTrailer_orig=selectTrailer; selectTrailer=function(id){ _selectTrailer_orig(id); syncAxleParamsFromTrailer(); calcAxles(); };

/* ===================== Maps (Google/Yandex) ===================== */
let _gmapsLoading=false, _gmapsLoaded=false, _ymapsLoading=false, _ymapsLoaded=false, _acFrom=null, _acTo=null, _fromPlaceId=null, _toPlaceId=null, _yaSuggestFrom=null, _yaSuggestTo=null;
function loadGoogleMaps(key){
  return new Promise((resolve,reject)=>{
    if(_gmapsLoaded){ resolve(); return; }
    if(_gmapsLoading){ const iv=setInterval(()=>{ if(_gmapsLoaded){ clearInterval(iv); resolve(); } }, 200); return; }
    if(!key) return reject(new Error('Укажите API key'));
    _gmapsLoading=true; const s=document.createElement('script'); s.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(key)}&libraries=places`; s.async=true; s.defer=true; s.onload=()=>{ _gmapsLoaded=true; resolve(); }; s.onerror=()=>{ _gmapsLoading=false; reject(new Error('Не удалось загрузить Google Maps JS API')); }; document.head.appendChild(s);
  });
}
function ensureAutocompleteGoogle(){
  if(!_gmapsLoaded) return;
  if(!_acFrom){ _acFrom=new google.maps.places.Autocomplete($('routeFrom'), { types:['(cities)'] }); _acFrom.addListener('place_changed', ()=>{ const p=_acFrom.getPlace(); _fromPlaceId=p?.place_id||null; }); }
  if(!_acTo){ _acTo=new google.maps.places.Autocomplete($('routeTo'), { types:['(cities)'] }); _acTo.addListener('place_changed', ()=>{ const p=_acTo.getPlace(); _toPlaceId=p?.place_id||null; }); }
}
function routeGoogle(key, fromStr, toStr, avoidTolls, truckMode){
  return loadGoogleMaps(key).then(()=>{
    ensureAutocompleteGoogle();
    return new Promise((resolve,reject)=>{
      const svc=new google.maps.DirectionsService();
      const origin=_fromPlaceId? {placeId:_fromPlaceId} : fromStr;
      const destination=_toPlaceId? {placeId:_toPlaceId} : toStr;
      svc.route({ origin, destination, travelMode:google.maps.TravelMode.DRIVING, provideRouteAlternatives:false, avoidFerries:true, avoidTolls, avoidHighways:false }, (res,status)=>{
        if(status!=='OK') { reject(new Error('Directions error: '+status)); return; }
        try{
          const meters=res.routes[0].legs.reduce((s,leg)=>s+(leg.distance?.value||0),0); let km=meters/1000;
          if(truckMode) km *= 1.12; // поправка на грузовые объезды
          resolve(Math.round(km));
        }catch(e){ reject(new Error('Ошибка обработки маршрута')); }
      });
    });
  });
}
function loadYandexMaps(key){
  return new Promise((resolve,reject)=>{
    if(_ymapsLoaded){ resolve(); return; }
    if(_ymapsLoading){ const iv=setInterval(()=>{ if(_ymapsLoaded){ clearInterval(iv); resolve(); } }, 200); return; }
    if(!key) return reject(new Error('Укажите API key'));
    _ymapsLoading=true;
    const s=document.createElement('script');
    s.src=`https://api-maps.yandex.ru/2.1/?apikey=${encodeURIComponent(key)}&lang=ru_RU`;
    s.onload=()=>{ ymaps.ready(()=>{ _ymapsLoaded=true; resolve(); }); };
    s.onerror=()=>{ _ymapsLoading=false; reject(new Error('Не удалось загрузить Яндекс.Карты JS API')); };
    document.head.appendChild(s);
  });
}
function ensureSuggestYandex(){
  if(!_ymapsLoaded) return;
  if(!_yaSuggestFrom) _yaSuggestFrom = new ymaps.SuggestView('routeFrom');
  if(!_yaSuggestTo) _yaSuggestTo = new ymaps.SuggestView('routeTo');
}
function routeYandex(key, fromStr, toStr, avoidTolls, truckMode){
  return loadYandexMaps(key).then(()=>{
    ensureSuggestYandex();
    return ymaps.route([fromStr, toStr], { avoidTrafficJams: false }).then(route=>{
      const len = route.getLength(); let km = len/1000;
      if(truckMode) km *= 1.12;
      return Math.round(km);
    });
  });
}
function maybeInitMaps(){
  if(app.distanceMode!=='maps') return;
  const key=$('mapsKey').value.trim(); const provider=$('provider').value;
  if(!key) return;
  if(provider==='google') loadGoogleMaps(key).then(ensureAutocompleteGoogle).catch(()=>{});
  else loadYandexMaps(key).then(ensureSuggestYandex).catch(()=>{});
}
function buildRoute(){
  if(app.distanceMode!=='maps'){ alert('Включите режим «Через карты».'); return; }
  const key=$('mapsKey').value.trim(); const fromStr=$('routeFrom').value.trim(); const toStr=$('routeTo').value.trim();
  const avoidTolls=$('avoidTolls').checked; const truckMode=$('truckMode').checked;
  if(!fromStr||!toStr){ alert('Заполните поля Откуда и Куда'); return; }
  const provider=$('provider').value;
  const runner = provider==='google' ? routeGoogle : routeYandex;
  runner(key, fromStr, toStr, avoidTolls, truckMode)
    .then(km=>{ $('distanceKm').value=String(km); app.distanceKm=km; saveState(); recalc(); })
    .catch(err=>alert(err.message||String(err)));
}

/* ===================== Tests ===================== */
function runTests(){
  const out=$('testResults'); const results=[]; const approx=(a,b,e=2)=>Math.abs(a-b)<=e;
  const pass=n=>results.push(`<div class='pass'>✔ ${n}</div>`); const fail=(n,m='')=>results.push(`<div class='fail'>✘ ${n}${m?': '+m:''}</div>`);
  const backup=JSON.stringify(app);
  try{
    // ρ прямой: литры → тонны, ADR остаётся «Не знаю»
    selectTrailer('MO0882_23');
    let tb=$('tankBody'); let first=tb.querySelector('tr');
    first.querySelector('.selType').value='syrup';
    first.querySelector('.inpRho').value='';
    first.querySelector('.inpL').value='1500';
    recalc();
    let tons=parseFloat(first.querySelector('.inpT').value); if(approx(tons*1000,1950,2)) pass('ρ: 1500 л сиропа → ~1.95 т'); else fail('ρ прямой', `получили ${tons.toFixed(3)} т`);
    const adrVal=first.querySelector('.selAdr').value; if(adrVal==='Не знаю') pass('ADR по умолчанию сохраняется «Не знаю»'); else fail('ADR остаётся «Не знаю»', adrVal);

    // Распределение по массе
    $('chkAllSame').checked=true; $('chkAllSame').dispatchEvent(new Event('change'));
    $('totalMassT').value='12';
    applyDistributionMass(12000);
    const totalT=app.trailerState.rows.reduce((s,r)=>s+(r.kg||0),0)/1000;
    if(Math.abs(totalT-12)<=0.02) pass('Распределение по массе на 12 т'); else fail('Распределение по массе', totalT.toFixed(3)+' т');
    const leftKg=app.fitStats?.leftKg||0; if(Math.abs(leftKg)<1e-3) pass('Распределение: остаток массы 0'); else fail('Распределение остаток', leftKg.toFixed(1)+' кг');

    // Пресет МО 0882 23 — строка лимитов скрыта
    const capsNode=$('capsLine');
    const capsWrapper=capsNode?.closest('.small');
    if(capsNode?.textContent==='' && capsWrapper?.style.display==='none') pass('Пресет МО 0882 23');
    else fail('Пресет МО 0882 23', `${capsNode?.textContent} / ${capsWrapper?.style.display}`);

    // Площадка ER 8977 23
    selectTrailer('ER8977_23');
    if($('platformSection').style.display==='block' && $('tankSection').style.display==='none') pass('Площадка рендерится'); else fail('Площадка рендер');

    // Кастом прицеп
    localStorage.setItem(LS_KEYS.custom, JSON.stringify([]));
    $('m_name').value='МК 9999 23'; $('m_type').value='tanker'; $('m_axles').value='4'; $('m_tare').value='7800'; $('m_caps').value='10000/8000/7000';
    saveModalTrailer();
    const all=getAllTrailers(); if(all.find(x=>x.name==='МК 9999 23')) pass('Кастом добавлен'); else fail('Кастом не добавлен');

    // Стоимость вручную
    $('distanceMode').value='manual'; $('distanceKm').value='100'; $('ratePerKm').value='50'; $('trips').value='2'; recalc();
    const costText=$('kpiCost').textContent.replace(/\D+/g,''); if(parseInt(costText)===10000) pass('Стоимость вручную считается'); else fail('Стоимость вручную', $('kpiCost').textContent);

    // Осевые
    $('recalcAxles')?.click();
    const gtotal=$('G_total_ax').textContent; if(gtotal && gtotal!=='—') pass('Осевые: масса поезда рассчитана'); else fail('Осевые расчёты');
  }catch(e){ fail('Исключение тестов', e.message); }
  finally{ try{ app=JSON.parse(backup); renderCurrent(); }catch(_){} }
  out.innerHTML=results.join('');
}

/* ===================== Boot ===================== */
function boot(){
  renderTrailerSelect();
  loadState();
  if(!app.selectedTrailerId){ const all=getAllTrailers(); app.selectedTrailerId=all[0].id; app.tractorAxles=2; }
  renderTrailerSelect(app.selectedTrailerId);
  selectTrailer(app.selectedTrailerId);
  bind();
}
window.addEventListener('load', ()=>{ boot(); syncAxleParamsFromTrailer(); calcAxles(); const ver=$('bver'); if(ver) ver.textContent=new Date().toISOString().slice(0,19).replace('T',' '); });
</script>
<div id="ver" style="position:fixed;right:10px;bottom:10px;font:12px system-ui;color:#6b7280;opacity:.8">build: <span id="bver"></span></div>
</body>
</html>
