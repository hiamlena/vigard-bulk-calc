<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Вигард — калькулятор наливных грузов</title>
  <link rel="icon" href="data:,V" />
  <style>
    :root{--bg:#f7f7f8;--card:#ffffff;--text:#111827;--muted:#6b7280;--accent:#0ea5e9;--good:#16a34a;--bad:#dc2626;--warn:#ca8a04;--border:#e5e7eb}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;background:var(--bg);color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    .title{display:flex;gap:12px;align-items:center;margin:8px 0 16px}
    .title h1{font-size:22px;margin:0}
    .muted{color:var(--muted);font-size:14px}
    .grid{display:grid;gap:16px}
    @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 16px rgba(0,0,0,.04)}
    .card .c{padding:16px}
    label{display:block;font-size:13px;color:#374151;margin:6px 0}
    input,textarea,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;font-size:14px;outline:none}
    input::placeholder{color:#9aa3af}
    input:focus,textarea:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(14,165,233,.15)}
    .row{display:grid;gap:12px}
    @media(min-width:720px){.row.cols-2{grid-template-columns:1fr 1fr}.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-4{grid-template-columns:repeat(4,1fr)}}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    .btn{border:1px solid var(--border);background:#fff;border-radius:12px;padding:10px 14px;font-size:14px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .small{font-size:12px;color:var(--muted)}
    .kpi{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    .kpi .box{border:1px solid var(--border);border-radius:12px;padding:12px}
    .kpi .t{color:var(--muted);font-size:12px}
    .kpi .v{font-weight:600;font-size:18px}
    .banner{border:1px dashed #facc15;background:#fffbeb;padding:12px;border-radius:12px}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{font-size:14px;vertical-align:middle}
    th{color:#374151;text-align:left}
    td>input,td>select{width:100%}
    .cap{font-size:12px;color:#6b7280}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef6ff;color:#0b6aa8;font-size:12px}
    .warn{color:#b45309}
    .danger{color:#b91c1c}
    details.tests{margin-top:12px}
    details.tests summary{cursor:pointer}
    .pass{color:#16a34a}
    .fail{color:#dc2626}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.3);padding:20px;z-index:20}
    .modal.open{display:flex}
    .modal>.sheet{background:#fff;border-radius:16px;padding:16px;max-width:640px;width:100%;border:1px solid var(--border)}
    .row.inline{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <div style="width:36px;height:36px;border-radius:10px;background:#e0f2fe;display:flex;align-items:center;justify-content:center;font-weight:700;color:#0369a1">V</div>
      <div>
        <h1>Вигард — калькулятор наливных грузов</h1>
        <div class="muted">Груз всегда застрахован. ДОПОГ соблюдаем.</div>
      </div>
    </div>

    <!-- Конфигурация -->
    <div class="card"><div class="c">
      <h2 style="margin:0 0 12px">Конфигурация</h2>
      <div class="row cols-3">
  <div>
    <label>Тягач (оси)</label>
    <select id="tractorAxles">
      <option value="2">2</option>
      <option value="3">3</option>
    </select>
  </div>

  <div>
    <label>Тягач (госномер)</label>
    <div style="display:flex;gap:6px;align-items:center">
      <select id="tractorSelect" style="flex:1"></select>
      <button class="btn" id="addTruck" title="Добавить тягач">+</button>
    </div>
  </div>

  <div>
    <label>Прицеп (номер)</label>
    <div style="display:flex;gap:6px;align-items:center">
      <select id="trailerSelect" style="flex:1"></select>
      <button class="btn" id="addTrailer" title="Добавить прицеп">+</button>
    </div>
  </div>
</div>

<div id="trailerInfo" class="small" style="margin-top:6px"></div>

    </div></div>

    <!-- Маршрут и стоимость -->
    <div class="card"><div class="c">
      <h2 style="margin:0 0 12px">Маршрут и стоимость</h2>

      <div class="row cols-3">
        <div>
          <label>Провайдер маршрута</label>
          <select id="provider">
            <option value="google">Google</option>
            <option value="yandex">Яндекс</option>
          </select>
        </div>
        <div>
          <label>Режим расстояния</label>
          <select id="distanceMode">
            <option value="manual">Вручную</option>
            <option value="gmaps">Через карты</option>
          </select>
        </div>
        <div>
          <label>API-ключ (для карт)</label>
          <input id="mapsKey" placeholder="вставьте ключ API">
        </div>
      </div>

      <!-- Поля маршрута ВСЕГДА видны -->
      <div class="row cols-3">
        <div>
          <label>Откуда (город)</label>
          <input id="routeFrom" placeholder="Введите название">
        </div>
        <div>
          <label>Куда (город)</label>
          <input id="routeTo" placeholder="Введите название">
        </div>
        <div id="gmapsRow" style="align-self:end" class="btns">
          <label class="small" style="display:flex;gap:6px;align-items:center"><input id="avoidTolls" type="checkbox"> избегать платных</label>
          <label class="small" style="display:flex;gap:6px;align-items:center"><input id="truckMode" type="checkbox" checked> грузовой режим*</label>
          <button class="btn" id="btnRoute">Построить маршрут</button>
        </div>
      </div>
      <div class="small" id="gmapsNote" style="display:none;margin-top:6px">* «Грузовой режим» приблизительно учитывает объезды (добавляет ~12% к километражу). Для строгих ограничений можно интегрировать HERE/Yandex Truck API.</div>

      <div class="row cols-3" style="margin-top:8px">
        <div>
          <label>Расстояние, км (если вручную)</label>
          <input id="distanceKm" type="number" placeholder="введите число">
        </div>
        <div>
          <label>Ставка, ₽/км</label>
          <input id="ratePerKm" type="number" placeholder="например 120">
        </div>
        <div>
          <label>Количество рейсов</label>
          <input id="trips" type="number" value="1">
        </div>
      </div>

      <div class="kpi" style="margin-top:12px">
        <div class="box"><div class="t">Расстояние</div><div class="v" id="kpiDistance">—</div></div>
        <div class="box"><div class="t">Ставка</div><div class="v" id="kpiRate">—</div></div>
        <div class="box"><div class="t">Рейсов</div><div class="v" id="kpiTrips">—</div></div>
        <div class="box"><div class="t">Итого стоимость</div><div class="v" id="kpiCost">—</div></div>
      </div>
    </div></div>

    <div class="grid" style="margin-top:16px">
      <!-- Цистерна / Площадка -->
      <div class="card"><div class="c">
        <h3 style="margin:0 0 8px">Отсеки / позиции</h3>

        <div id="tankSection">
          <div class="row inline" style="justify-content:space-between;margin:6px 0 8px;gap:12px;flex-wrap:wrap">
            <label class="small" style="display:flex;gap:8px;align-items:center"><input id="chkAllSame" type="checkbox"> все отсеки — один груз</label>
            <button class="btn" id="btnAddProduct">+ Добавить груз</button>
          </div>

          <div class="row cols-3" style="margin:0 0 12px">
            <div>
              <label>Сколько везём (масса), т</label>
              <div class="row inline" style="gap:8px;align-items:center">
                <input id="totalMassT" type="number" step="0.01" min="0" placeholder="например 12">
                <button class="btn" id="btnDistributeMass">Распределить по массе</button>
              </div>
            </div>
            <div>
              <label>Сколько везём (объём), м³</label>
              <div class="row inline" style="gap:8px;align-items:center">
                <input id="totalVolumeM3" type="number" step="0.01" min="0" placeholder="например 28.5">
                <button class="btn" id="btnDistributeM3">Распределить объём</button>
              </div>
            </div>
            <div>
              <label>…или объём, л</label>
              <div class="row inline" style="gap:8px;align-items:center">
                <input id="totalVolumeL" type="number" step="1" min="0" placeholder="например 28500">
                <button class="btn" id="btnDistributeL">Распределить литры</button>
              </div>
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th>Отсек</th><th>Тип груза</th><th>ADR</th><th>ρ (кг/л)</th><th>Объём, л</th><th>Тонны, т</th>
              </tr>
            </thead>
            <tbody id="tankBody"></tbody>
          </table>

          <div class="small">Лимиты по отсекам: <span id="capsLine"></span></div>
          <div class="small" id="fitSummary" style="margin-top:6px"></div>

          <div class="btns" style="margin-top:8px">
            <button class="btn" id="fillMax">Заполнить по максимуму</button>
            <button class="btn" id="clearAll">Очистить</button>
          </div>
        </div>

        <div id="platformSection" style="display:none">
          <table>
            <thead><tr><th>Позиция</th><th>Масса, кг</th></tr></thead>
            <tbody id="platBody"></tbody>
          </table>
        </div>
      </div></div>

      <!-- Итоги -->
      <div class="card"><div class="c">
        <h3 style="margin:0 0 8px">Итоги и предупреждения</h3>
        <div class="kpi">
          <div class="box"><div class="t">Сумма литров</div><div class="v" id="sumL">—</div></div>
          <div class="box"><div class="t">Сумма тонн</div><div class="v" id="sumT">—</div></div>
        </div>
        <ul id="warnList" class="small" style="margin-top:8px"></ul>
        <div style="margin-top:16px">
          <div style="font-weight:600;margin-bottom:6px">Мини-бриф</div>
          <textarea id="brief" rows="8" readonly></textarea>
        </div>
        <div class="btns" style="margin-top:8px">
          <button class="btn" id="copyBrief">Скопировать мини-бриф</button>
          <button class="btn primary" id="submitBtn">Оформить / Сохранить расчёт</button>
        </div>

        <details class="tests"><summary>Тесты (debug)</summary>
          <div class="btns" style="margin:8px 0"><button class="btn" id="runTests">Запустить тесты</button></div>
          <div id="testResults" class="small"></div>
        </details>
      </div></div>
    </div>
  </div>

  <!-- Modal: прицеп -->
  <div id="modal" class="modal"><div class="sheet">
    <h3 style="margin-top:0">Добавить прицеп</h3>
    <div class="row cols-2">
      <div><label>Номер (как в списке)</label><input id="m_name" placeholder="МК 9999 23"></div>
      <div><label>Тип</label><select id="m_type"><option value="tanker">Цистерна</option><option value="platform">Площадка</option></select></div>
    </div>
    <div class="row cols-3">
      <div><label>Оси</label><select id="m_axles"><option>3</option><option selected>4</option></select></div>
      <div><label>Тара, кг</label><input id="m_tare" type="number" placeholder="7800"></div>
      <div id="m_positions_wrap" style="display:none"><label>Позиции (для площадки)</label><input id="m_positions" type="number" value="4"></div>
    </div>
    <div id="m_caps_wrap"><label>Отсеки (литры) через «/»</label><input id="m_caps" placeholder="10000/8000/9000"></div>
    <div class="btns" style="margin-top:10px">
      <button class="btn primary" id="m_save">Сохранить</button>
      <button class="btn" id="m_cancel">Отмена</button>
    </div>
  </div></div>

  <!-- Modal: тягач -->
  <div id="modalTruck" class="modal"><div class="sheet">
    <h3 style="margin-top:0">Добавить тягач</h3>
    <div class="row cols-2">
      <div><label>Госномер</label><input id="mt_plate" placeholder="А 123 БВ 93"></div>
      <div><label>Оси</label><select id="mt_axles"><option value="2" selected>2</option><option value="3">3</option></select></div>
    </div>
    <div class="btns" style="margin-top:10px">
      <button class="btn primary" id="mt_save">Сохранить</button>
      <button class="btn" id="mt_cancel">Отмена</button>
    </div>
  </div></div>

  <!-- Axle calc -->
  <div class="wrap" style="margin-top:8px">
    <div class="card"><div class="c">
      <h2 style="margin:0 0 12px">Расчёт нагрузок на оси</h2>
      <div class="small" style="margin:-6px 0 10px">Упрощённая статика для автопоезда (тягач + полуприцеп). Если нет точной геометрии — используются типовые значения.</div>

      <h3 style="margin:8px 0">Параметры тягача</h3>
      <div class="row cols-3">
        <div>
          <label>Оси тягача</label>
          <select id="axTr_axle"><option value="2">2</option><option value="3">3</option></select>
        </div>
        <div>
          <label>База LT (мм, 1-я ↔ задняя группа)</label>
          <input id="LT_ax" type="number" value="3800" />
        </div>
        <div>
          <label>l2 (мм, задняя ось → седло)</label>
          <input id="l2_ax" type="number" value="350" />
        </div>
      </div>
      <div class="row cols-3">
        <div>
          <label>Нагрузка пустого: перед NT1,0 (кг)</label>
          <input id="NT10_ax" type="number" value="4200" />
        </div>
        <div>
          <label>Нагрузка пустого: зад гр. NT2,0 (кг)</label>
          <input id="NT20_ax" type="number" value="4000" />
        </div>
        <div>
          <label>Оси прицепа (из пресета)</label>
          <input id="axTl_ax" type="number" value="3" readonly />
        </div>
      </div>

      <h3 style="margin:8px 0">Параметры полуприцепа</h3>
      <div class="row cols-4">
        <div>
          <label>Масса пустого mp (кг)</label>
          <input id="mp_ax" type="number" value="7300" />
        </div>
        <div>
          <label>LA (мм, длина площадки)</label>
          <input id="LA_ax" type="number" value="12000" />
        </div>
        <div>
          <label>LB (мм, центр тележки → седло)</label>
          <input id="LB_ax" type="number" value="7600" />
        </div>
        <div>
          <label>LC (мм, центр тележки → зад)</label>
          <input id="LC_ax" type="number" value="4400" />
        </div>
      </div>
      <div class="row cols-3">
        <div>
          <label>Нагрузка пустого на седло NTp.p. (кг)</label>
          <input id="NTpp_ax" type="number" value="2000" />
        </div>
        <div style="align-self:end" class="btns">
          <button class="btn" id="recalcAxles">Пересчитать оси</button>
        </div>
      </div>

      <div class="kpi" style="margin-top:12px">
        <div class="box"><div class="t">Масса автопоезда</div><div class="v" id="G_total_ax">—</div></div>
        <div class="box"><div class="t">Ось 1 (передняя, тягач)</div><div class="v" id="Ax1_ax">—</div></div>
        <div class="box"><div class="t">Задняя группа тягача</div><div class="v" id="Ax2_ax">—</div></div>
        <div class="box"><div class="t">Тележка прицепа (сумма / по оси)</div><div class="v" id="AxTl_ax">—</div></div>
      </div>
      <div class="banner" id="axWarn_ax" style="display:none;margin-top:10px"></div>
      <div class="small" style="margin-top:6px">Грубая модель: равномерное распределение по тележке прицепа и задней группе тягача. Для точного расчёта нужны паспортные размеры.</div>
    </div></div>
  </div>

  <div id="ver" style="position:fixed;right:10px;bottom:10px;font:12px system-ui;color:#6b7280;opacity:.8">build: <span id="bver"></span></div>

  <script src="app.js"></script>
  <script>
    (function(){
      const verEl=document.getElementById('bver');
      if(verEl){ verEl.textContent=new Date().toISOString().slice(0,19).replace('T',' '); }

      const hasDomHelpers=typeof window.$==='function';
      if(!hasDomHelpers){ return; }

      const { fmtL, fmtT, fmtLitersDetailed, fmtTonsDetailed, num, getAllProducts, ensureRowsMatchCaps } = (function(){
        return {
          fmtL: window.fmtL,
          fmtT: window.fmtT,
          fmtLitersDetailed: window.fmtLitersDetailed,
          fmtTonsDetailed: window.fmtTonsDetailed,
          num: window.num,
          getAllProducts: window.getAllProducts,
          ensureRowsMatchCaps: window.ensureRowsMatchCaps
        };
      })();

      if(!fmtL || !fmtT || !fmtLitersDetailed || !fmtTonsDetailed || !num || !getAllProducts || !ensureRowsMatchCaps){ return; }

      const tankBodyEl=document.getElementById('tankBody');
      if(tankBodyEl){ tankBodyEl.innerHTML=''; }

      function buildTankRows(state){
        const tb=$('tankBody');
        if(!tb){ return; }
        tb.innerHTML='';
        const caps=state.caps||[];
        const capsLine=$('capsLine');
        if(capsLine){ capsLine.textContent=caps.map((c,i)=>`#${i+1}: ${Number(c).toLocaleString('ru-RU')} л`).join(', '); }
        const allProducts=getAllProducts();
        state.rows.forEach((row,idx)=>{
          const tr=document.createElement('tr');
          const adrOptions=['Не знаю','3','8','—'];
          const product=allProducts.find(p=>p.key===(row.typeKey||''))||allProducts[0];
          const rhoVal=num(row.rho, product?.rho||1);
          const litersVal=num(row.liters,0);
          const tonsVal=Number.isFinite(row.tons)? row.tons : (litersVal*rhoVal)/1000;
          const currentAdr=row.adr||'Не знаю';
          if(!adrOptions.includes(String(currentAdr))){ adrOptions.push(String(currentAdr)); }
          tr.dataset.index=String(idx);
          tr.innerHTML=
            `<td><span class="pill">#${idx+1}</span><div class="cap">лимит ${caps[idx]??'—'} л</div></td>`+
            `<td><select class="selType">${allProducts.map(d=>`<option value="${d.key}" ${d.key===(row.typeKey||'diesel')?'selected':''}>${d.label}</option>`).join('')}</select></td>`+
            `<td><select class="selAdr">${adrOptions.map(o=>`<option value="${o}" ${String(currentAdr)===String(o)?'selected':''}>${o}</option>`).join('')}</select></td>`+
            `<td><input class="inpRho" type="number" step="0.001" value="${(rhoVal||0).toFixed(3)}"></td>`+
            `<td><input class="inpL" type="number" step="0.01" value="${litersVal||0}"></td>`+
            `<td><input class="inpT" type="number" readonly value="${isFinite(tonsVal)? tonsVal.toFixed(3):'0.000'}"></td>`;
          tb.appendChild(tr);
        });
      }

      const originalRenderCurrent=window.renderCurrent;
      window.buildTankRows=buildTankRows;

      function recalcCore(){
        if(!window.app || !app.trailerState){ return; }
        const tstate=app.trailerState;
        const warns=[];
        let sumL=0;
        let sumT=0;

        if($('tractorSelect')) app.tractorPlate=$('tractorSelect').value||app.tractorPlate;

        if(tstate.type==='tanker'){
          const tb=$('tankBody');
          const rows=[...tb.querySelectorAll('tr')];
          ensureRowsMatchCaps(tstate);
          const same=$('chkAllSame')?.checked || false;
          tstate.sameCargo=same;

          let firstType=null;
          let firstRho=1;
          let firstAdr='Не знаю';
          let firstAdrEdited=false;
          let manualOverflowLiters=0;
          let manualOverflowTons=0;

          rows.forEach((tr,i)=>{
            const prev=tstate.rows[i]||{};
            const typeEl=tr.querySelector('.selType');
            let typeKey=typeEl?.value || prev.typeKey || 'diesel';
            let dict=getAllProducts().find(d=>d.key===typeKey);
            if(!dict){ const fallback=getAllProducts()[0]; if(fallback){ typeKey=fallback.key; dict=fallback; if(typeEl) typeEl.value=fallback.key; } }

            const rhoInp=tr.querySelector('.inpRho');
            const prevType=prev.typeKey;
            if(prevType!==typeKey && rhoInp && dict){ rhoInp.value=(dict.rho||1).toFixed(3); }
            let rho=num(rhoInp?.value, dict?.rho || prev.rho || 1);
            if(!isFinite(rho) || rho<=0){ rho=dict?.rho || 1; if(rhoInp) rhoInp.value=(rho||1).toFixed(3); }

            const adrSel=tr.querySelector('.selAdr');
            let adr=adrSel? adrSel.value : (prev.adr||'Не знаю');
            let adrEdited=!!prev.adrEdited;
            if(prevType!==typeKey){
              if(adrSel && !adrSel.value){ adrSel.value='Не знаю'; }
              if(!adrEdited || adr==='Не знаю'){ adr='Не знаю'; adrEdited=false; if(adrSel) adrSel.value='Не знаю'; }
            }

            if(i===0){
              firstType=typeKey; firstRho=rho; firstAdr=adr; firstAdrEdited=adrEdited;
            } else if(same){
              if(typeEl && typeEl.value!==firstType) typeEl.value=firstType;
              if(rhoInp) rhoInp.value=(firstRho||1).toFixed(3);
              if(adrSel) adrSel.value=firstAdr;
              typeKey=firstType; rho=firstRho; adr=firstAdr; adrEdited=firstAdrEdited;
            }

            const lInp=tr.querySelector('.inpL');
            let liters=num(lInp?.value, prev.liters || 0);
            if(!isFinite(liters)) liters=0;
            if(liters<0){ warns.push(`Отсек #${i+1}: отрицательный объём, обнулил`); liters=0; if(lInp) lInp.value='0'; }

            const cap=tstate.caps[i]??Infinity;
            const over=Math.max(0, liters-cap);
            if(over>0){ warns.push(`Переполнение отсека #${i+1}: ${fmtLitersDetailed(liters)} л > лимита ${cap} л`); }

            const tons=(liters*rho)/1000;
            const tInp=tr.querySelector('.inpT');
            if(tInp) tInp.value=isFinite(tons)? tons.toFixed(3):'0.000';

            tstate.rows[i]={ typeKey, adr, adrEdited, rho, liters, tons };
            sumL+=liters;
            sumT+=tons;
            manualOverflowLiters+=over;
            manualOverflowTons+=(over*rho)/1000;
          });

          if(manualOverflowLiters>0){ tstate.lastDistribution=null; }

          const capsLineEl=$('capsLine');
          if(capsLineEl){ capsLineEl.textContent=(tstate.caps||[]).map((capL,i)=>`#${i+1}: ${Number(capL).toLocaleString('ru-RU')} л`).join(', '); }

          let fitL=0;
          let fitTons=0;
          (tstate.rows||[]).forEach((r,i)=>{
            const cap=tstate.caps[i]??0;
            const liters=r.liters||0;
            const rho=r.rho||0;
            const put=Math.min(liters, cap);
            fitL+=put;
            fitTons+=(put*rho)/1000;
          });

          let overflow={ liters: manualOverflowLiters, tons: manualOverflowTons };
          if((overflow.liters||0)<=0 && tstate.lastDistribution){ overflow={ ...tstate.lastDistribution }; }

          const parts=(tstate.caps||[]).map((capL,i)=>{
            const r=tstate.rows[i]||{};
            const maxT=(capL*(r.rho||0))/1000;
            return `#${i+1}: ${Number(capL).toLocaleString('ru-RU')} л (≈ ${fmtTonsDetailed(maxT)} т)`;
          });

          const fitBox=$('fitSummary');
          if(fitBox){
            let html=`Влезет по лимитам: <b>${fmtLitersDetailed(fitL)}</b> л / ${fmtTonsDetailed(fitTons)} т`;
            if((overflow.liters||0)>0){
              html+=`<br>Не влезло: <b>${fmtLitersDetailed(overflow.liters)}</b> л / ${fmtTonsDetailed(overflow.tons||0)} т`;
            }
            if(parts.length) html+=`<br>${parts.join('; ')}`;
            fitBox.innerHTML=html;
          }

        } else {
          const tb=$('platBody');
          const rows=[...tb.querySelectorAll('tr')];
          let masses=[];
          rows.forEach((tr,i)=>{
            let m=num(tr.querySelector('.inpMass')?.value,0);
            if(m<0){ warns.push(`Позиция #${i+1}: отрицательная масса`); m=0; }
            masses[i]=m;
            sumT+=m/1000;
          });
          tstate.masses=masses;
          sumL=NaN;
        }

        $('sumL').textContent=isNaN(sumL)? '—' : fmtL(sumL);
        if($('sumT')) $('sumT').textContent=fmtT(sumT);

        const ul=$('warnList');
        if(ul){
          ul.innerHTML='';
          if(warns.length===0){ const li=document.createElement('li'); li.textContent='Ошибок не обнаружено.'; ul.appendChild(li); }
          else { warns.forEach(w=>{ const li=document.createElement('li'); li.innerHTML=`<span class="warn">⚠</span> ${w}`; ul.appendChild(li); }); }
        }

        app.distanceKm=num($('distanceKm')?.value, app.distanceKm||0);
        app.ratePerKm=num($('ratePerKm')?.value, app.ratePerKm||0);
        app.trips=parseInt($('trips')?.value)||app.trips||1;
        const cost=app.distanceKm*app.ratePerKm*app.trips;
        if($('kpiDistance')) $('kpiDistance').textContent=(isFinite(app.distanceKm)&&app.distanceKm>0)? (Math.round(app.distanceKm).toLocaleString('ru-RU')+' км'):'—';
        if($('kpiRate')) $('kpiRate').textContent=(isFinite(app.ratePerKm)&&app.ratePerKm>0)? (app.ratePerKm.toLocaleString('ru-RU')+' ₽/км'):'—';
        if($('kpiTrips')) $('kpiTrips').textContent=String(app.trips);
        if($('kpiCost')) $('kpiCost').textContent=(isFinite(cost)&&cost>0)? cost.toLocaleString('ru-RU')+' ₽':'—';

        const t=getAllTrailers().find(x=>x.id===app.selectedTrailerId);
        let lines=[`Прицеп: ${t?.name||''} (${t?.type==='tanker'?'цистерна':'площадка'})`, `Тягач: ${app.tractorPlate||'—'} (${app.tractorAxles} оси)`, `Итоги: ${(isNaN(sumL)?'-':Math.round(sumL)+' л')}, ${sumT.toFixed(3)} т`];
        if(tstate.type==='tanker'){
          tstate.rows.forEach((r,i)=>{
            const d=getAllProducts().find(x=>x.key===r.typeKey);
            lines.push(`#${i+1}: ${(d?.label)||r.typeKey}, ADR ${r.adr}, ρ=${(r.rho||0).toFixed(3)}, ${fmtLitersDetailed(r.liters||0)} л / ${(r.tons||0).toFixed(3)} т`);
          });
        } else {
          (tstate.masses||[]).forEach((kg,i)=>{ lines.push(`#${i+1}: ${(kg/1000).toFixed(3)} т`); });
        }
        const routeStr=(app.routeFrom||app.routeTo)? `Маршрут: ${app.routeFrom||'?'} → ${app.routeTo||'?'}`:'';
        const costStr=(isFinite(cost)&&cost>0)? `Стоимость: ${cost.toLocaleString('ru-RU')} ₽ (${app.distanceKm} км × ${app.ratePerKm} ₽/км × ${app.trips} рейс.)`:'';
        if(routeStr) lines.push(routeStr);
        if(costStr) lines.push(costStr);
        if($('brief')) $('brief').value=lines.join('\n');

        if(typeof window.saveState==='function') window.saveState();
      }

      function recalcWithAxles(){
        recalcCore();
        if(typeof window.calcAxles==='function') window.calcAxles();
      }

      window.recalc=recalcWithAxles;

      function distributeByLiters(litersValue){
        if(!window.app || !app.trailerState || app.trailerState.type!=='tanker'){ return; }
        const liters=Math.max(0, num(litersValue,0));
        const tstate=app.trailerState;
        const rowsEl=$('tankBody')? [...$('tankBody').querySelectorAll('tr')]:[];
        tstate.lastDistribution=null;
        rowsEl.forEach(tr=>{ const inp=tr.querySelector('.inpL'); if(inp) inp.value='0'; });
        let rest=liters;
        let lastRho=tstate.rows[0]?.rho||1;
        for(let i=0;i<tstate.caps.length;i++){
          const cap=tstate.caps[i]||0;
          const tr=rowsEl[i];
          if(!tr) continue;
          let rho=num(tr.querySelector('.inpRho')?.value, tstate.rows[i]?.rho||lastRho||1);
          if(!isFinite(rho) || rho<=0) rho=lastRho||1;
          lastRho=rho;
          const put=Math.min(cap, rest);
          const lInp=tr.querySelector('.inpL');
          if(lInp) lInp.value=put>0? String(Number(put.toFixed(2))):'0';
          rest-=put;
          if(rest<=0){ rest=0; break; }
        }
        const overflowLiters=Math.max(0, rest);
        const overflowTons=overflowLiters>0? (overflowLiters*(lastRho||1))/1000 : 0;
        tstate.lastDistribution={ liters: overflowLiters, tons: overflowTons };
        recalcWithAxles();
      }

      function distributeByMassKg(totalKg){
        if(!window.app || !app.trailerState || app.trailerState.type!=='tanker'){ return; }
        let restKg=Math.max(0, num(totalKg,0));
        const tstate=app.trailerState;
        const rowsEl=$('tankBody')? [...$('tankBody').querySelectorAll('tr')]:[];
        tstate.lastDistribution=null;
        rowsEl.forEach(tr=>{ const inp=tr.querySelector('.inpL'); if(inp) inp.value='0'; });
        const same=$('chkAllSame')?.checked || tstate.sameCargo;
        const firstRho=num(rowsEl[0]?.querySelector('.inpRho')?.value, tstate.rows[0]?.rho||1) || 1;
        let lastRhoUsed=firstRho||1;
        for(let i=0;i<tstate.caps.length;i++){
          const cap=tstate.caps[i]||0;
          const tr=rowsEl[i];
          if(!tr) continue;
          let rho=same ? firstRho : num(tr.querySelector('.inpRho')?.value, tstate.rows[i]?.rho||firstRho||1);
          if(!isFinite(rho) || rho<=0) rho=firstRho||1;
          lastRhoUsed=rho;
          const litersByMass=restKg/rho;
          const putL=Math.min(cap, litersByMass);
          const inp=tr.querySelector('.inpL');
          if(inp) inp.value=putL>0? String(Number(putL.toFixed(2))):'0';
          restKg-=putL*rho;
          if(restKg<=0){ restKg=0; break; }
        }
        restKg=Math.max(0, restKg);
        const overflowLiters=lastRhoUsed>0? restKg/lastRhoUsed:0;
        const overflowTons=restKg/1000;
        tstate.lastDistribution={ liters: overflowLiters, tons: overflowTons };
        recalcWithAxles();
      }

      window.distributeByLiters=distributeByLiters;
      window.distributeByMassKg=distributeByMassKg;

      function distributeByM3(totalM3){ distributeByLiters((num(totalM3,0)||0)*1000); }

      function setupDistributionControls(){
        const massBtn=$('btnDistributeMass');
        if(massBtn){
          massBtn.addEventListener('click', ()=>{
            const input=$('totalMassT');
            const value=num(input?.value,0);
            if(!(value>0)){ alert('Укажите массу (>0)'); return; }
            distributeByMassKg(value*1000);
          });
        }
        const m3Btn=$('btnDistributeM3');
        if(m3Btn){
          m3Btn.addEventListener('click', ()=>{
            const input=$('totalVolumeM3');
            const value=num(input?.value,0);
            if(!(value>0)){ alert('Укажите объём (>0)'); return; }
            distributeByM3(value);
          });
        }
        const lBtn=$('btnDistributeL');
        if(lBtn){
          lBtn.addEventListener('click', ()=>{
            const input=$('totalVolumeL');
            const value=num(input?.value,0);
            if(!(value>0)){ alert('Укажите объём (>0)'); return; }
            distributeByLiters(value);
          });
        }

        ['totalMassT','totalVolumeM3','totalVolumeL'].forEach(id=>{
          const el=$(id);
          if(el){ el.addEventListener('keydown', ev=>{ if(ev.key==='Enter'){ ev.preventDefault(); const targetBtn=id==='totalMassT'? $('btnDistributeMass'): id==='totalVolumeM3'? $('btnDistributeM3'): $('btnDistributeL'); targetBtn?.click(); } }); }
        });
      }

      function runTests(){
        const out=$('testResults');
        const results=[];
        const approx=(a,b,e=0.01)=>Math.abs(a-b)<=e;
        const pass=n=>results.push(`<div class='pass'>✔ ${n}</div>`);
        const fail=(n,m='')=>results.push(`<div class='fail'>✘ ${n}${m?': '+m:''}</div>`);
        const backup=JSON.stringify(app);
        try{
          selectTrailer('MO0882_23');
          const tb=$('tankBody');
          const first=tb?.querySelector('tr');
          if(!first) throw new Error('Нет строки для теста');

          first.querySelector('.selType').value='syrup';
          first.querySelector('.selType').dispatchEvent(new Event('change',{bubbles:true}));
          recalcWithAxles();
          const rhoVal=parseFloat(first.querySelector('.inpRho').value);
          if(approx(rhoVal,1.30,0.001)) pass('ρ берётся из справочника'); else fail('ρ из справочника', rhoVal);
          const adrVal=first.querySelector('.selAdr').value;
          if(adrVal==='Не знаю') pass('ADR по умолчанию «Не знаю»'); else fail('ADR по умолчанию', adrVal);

          const chk=$('chkAllSame'); if(chk){ chk.checked=true; chk.dispatchEvent(new Event('change',{bubbles:true})); }
          const massInput=$('totalMassT');
          if(massInput){ massInput.value='12'; }
          $('btnDistributeMass')?.click();
          const litersAfter=parseFloat(first.querySelector('.inpL').value);
          if(approx(litersAfter,9230.77,0.2)) pass('Масса распределена по ρ первой секции'); else fail('Распределение по массе', litersAfter);
          const tonsAfter=parseFloat(first.querySelector('.inpT').value);
          if(approx(tonsAfter,12,0.01)) pass('Тонны пересчитаны автоматически'); else fail('Пересчёт тонн', tonsAfter);

          const m3Input=$('totalVolumeM3');
          if(m3Input){ m3Input.value='28.5'; }
          $('btnDistributeM3')?.click();
          const litersAll=[...tb.querySelectorAll('.inpL')].reduce((s,inp)=>s+(parseFloat(inp.value)||0),0);
          if(approx(litersAll,27740,0.5)) pass('Распределение по м³ учитывает лимиты'); else fail('Распределение по м³', litersAll);
          const fitText=$('fitSummary')?.textContent||'';
          if(/Не влезло/.test(fitText)) pass('Итоги показывают остаток'); else fail('Остаток не отображён', fitText);

          $('clearAll')?.click();
          const zeroed=[...tb.querySelectorAll('.inpL')].every(inp=>(parseFloat(inp.value)||0)===0);
          if(zeroed) pass('Очистка обнуляет литры'); else fail('Очистка', 'значения не нули');
        }catch(e){
          fail('Исключение тестов', e.message||String(e));
        } finally {
          try{ app=JSON.parse(backup); window.normalizeAppState?.(); originalRenderCurrent?.call(window); recalcWithAxles(); }catch(_){ }
        }
        if(out) out.innerHTML=results.join('');
      }

      window.runTests=runTests;

      setupDistributionControls();
      if(typeof originalRenderCurrent==='function'){ originalRenderCurrent.call(window); }
      recalcWithAxles();

    })();
  </script>
</body>
</html>
